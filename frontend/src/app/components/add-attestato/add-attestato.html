<app-notification 
  [notifications]="notifications()"
  [showMultiple]="true"
  [mostSevereNotification]="getMostSevereNotification()">
</app-notification>

<section class="add-attestato">
  <div class="header">
    <button class="back-btn" type="button" (click)="goBack()" aria-label="Torna indietro">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
    </button>
    <h2 class="title">Aggiungi Attestato</h2>
  </div>

  <form class="form" [formGroup]="addAttestatoForm" (ngSubmit)="onSubmit()" novalidate>
      <label class="field col-1 c1 row-1" aria-label="Titolo">
        <input id="attestato-title" type="text" formControlName="title" placeholder=" " maxlength="150" (blur)="onFieldBlur('attestato.title')"/>
        <span class="field-label">Titolo *</span>
      </label>

      

      <label class="field col-1 c2 row-1" aria-label="Ente Rilasciante">
        <input id="attestato-issuer" type="text" formControlName="issuer" placeholder=" " maxlength="150" (blur)="onFieldBlur('attestato.issuer')"/>
        <span class="field-label">Ente Rilasciante</span>
      </label>

      <label class="field col-1 c1 row-2" aria-label="Data Rilascio">
        <input id="attestato-issued-at" type="date" formControlName="issued_at" [max]="todayStr" placeholder=" " (blur)="onFieldBlur('attestato.issued_at')"/>
        <span class="field-label">Data Rilascio</span>
      </label>
      <label class="field col-1 c2 row-2" aria-label="Data Scadenza">
        <input id="attestato-expires-at" type="date" formControlName="expires_at" [min]="addAttestatoForm.value.issued_at || null" placeholder=" " (blur)="onFieldBlur('attestato.expires_at')"/>
        <span class="field-label">Data Scadenza</span>
      </label>

      <label class="field field--textarea col-4" aria-label="Descrizione">
        <textarea id="attestato-description" formControlName="description" placeholder=" " rows="3" maxlength="1000" (blur)="onFieldBlur('attestato.description')"></textarea>
        <span class="field-label">Descrizione</span>
      </label>

      <label class="field col-4" aria-label="URL Credenziale">
        <input id="attestato-credential-url" type="url" formControlName="credential_url" placeholder=" " maxlength="255" (blur)="onFieldBlur('attestato.credential_url')"/>
        <span class="field-label">URL Credenziale (opzionale)</span>
      </label>

      <div class="add-attestato-modal__field c3 r1-2">
        <label class="add-attestato-modal__label">
          Immagine Attestato <span class="add-attestato-modal__required">*</span>
        </label>
        <input 
          #fileInput
          type="file" 
          accept="image/jpeg,image/png,image/jpg,image/gif,image/webp"
          (change)="onFileSelected($event)"
          [attr.disabled]="uploading() ? '' : null"
          style="display: none;">
        
        @if (!selectedFile()) {
          <button 
            type="button"
            class="add-attestato-modal__file-button"
            (click)="openFilePicker()"
            [disabled]="uploading()"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onFileDrop($event)"
            [class.is-dragover]="isDragOver()">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M21 19V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
            </svg>
            <span>Seleziona immagine</span>
          </button>
        } @else {
          <div class="add-attestato-modal__file-info" 
               (dragover)="onDragOver($event)" 
               (dragleave)="onDragLeave($event)" 
               (drop)="onFileDrop($event)"
               [class.is-dragover]="isDragOver()">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M21 19V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
            </svg>
            <span class="add-attestato-modal__filename">{{ selectedFile()?.name }}</span>
            <button 
              type="button"
              class="add-attestato-modal__remove-file"
              (click)="removeFile()"
              [disabled]="uploading()"
              aria-label="Rimuovi file">
              Ã—
            </button>
          </div>
        }
      </div>

      <div class="actions">
        <button type="button" class="btn btn-secondary" (click)="goBack()" [disabled]="uploading()">
          Annulla
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="addAttestatoForm.invalid || uploading() || !selectedFile()">
          @if (uploading()) { <span>Caricamento...</span> } @else { <span>Crea</span> }
        </button>
      </div>
  </form>
</section>


