<div class="aside-secondary">
  <!-- Header con icona GitHub -->
  <div class="aside-secondary__header">
    <svg class="aside-secondary__icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.603-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.464-1.11-1.464-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z"/>
    </svg>
    <h3 class="aside-secondary__title">GitHub</h3>
  </div>

  <!-- Contenuto principale -->
  <div class="aside-secondary__content">
    <!-- Contatore totale commit utente (da social_accounts) -->
    @if (githubUsername()) {
      <div class="aside-secondary__user-commits">
        @if (loadingUserCommits()) {
          <div class="aside-secondary__mini-loading">
            <div class="aside-secondary__mini-spinner"></div>
          </div>
        } @else {
          <div class="aside-secondary__user-commits-card">
            <svg class="aside-secondary__user-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <div class="aside-secondary__user-content">
              <span class="aside-secondary__user-value">{{ userTotalCommits() }}</span>
              <span class="aside-secondary__user-label">Commits Globali</span>
            </div>
          </div>
        }
      </div>
    }

    <!-- Statistiche repository specifiche (da github_repositories) -->
    @if (loadingRepos()) {
      <!-- Loading stato -->
      <div class="aside-secondary__loading">
        <div class="aside-secondary__spinner"></div>
        <p class="aside-secondary__loading-text">Caricamento repository...</p>
      </div>
    } @else {
      <!-- Lista repository -->
      @for (repo of repositories(); track repo.id; let i = $index) {
        <div class="aside-secondary__commits"
          [draggable]="canEdit()"
          (dragstart)="onDragStart($event, i)"
          (dragover)="onDragOver($event)"
          (drop)="onDrop($event, i)"
          (dragend)="onDragEnd()"
          [class.dragging]="draggedIndex() === i"
          [class.draggable-edit]="canEdit()">
          <div class="aside-secondary__commits-card">
            <!-- Nome repository come badge sul bordo superiore sinistro -->
            <span class="aside-secondary__repo-badge">{{ repo.repo }}</span>
            
            <!-- Bottone elimina (solo in edit mode) -->
            @if (canEdit()) {
              <button
                type="button"
                class="aside-secondary__delete-btn"
                (click)="onDeleteRepository(repo.id, repo.repo)"
                title="Elimina repository">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
              </button>
            }
            
            <svg class="aside-secondary__commits-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <line x1="3" y1="12" x2="9" y2="12"></line>
              <line x1="15" y1="12" x2="21" y2="12"></line>
            </svg>
            <div class="aside-secondary__commits-content">
              @if (getStatsForRepo(repo.url); as stats) {
                <span class="aside-secondary__commits-value">{{ stats.commits }}</span>
              } @else {
                <span class="aside-secondary__commits-value">-</span>
              }
              <span class="aside-secondary__commits-label">Commits Repository</span>
            </div>
          </div>
          
          @if (getStatsForRepo(repo.url)?.error) {
            <p class="aside-secondary__error">{{ getStatsForRepo(repo.url)!.error }}</p>
          }
        </div>
      }
    }

    <!-- Form per aggiungere/modificare repository (sempre visibile in edit mode) -->
    @if (canEdit()) {
      @if (!showForm()) {
        <!-- Bottone + per aggiungere repository (solo in edit mode) -->
        <button 
          type="button"
          class="aside-secondary__add-btn"
          (click)="onAddRepository()"
          title="Aggiungi repository GitHub">
          <svg class="aside-secondary__add-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          <span class="aside-secondary__add-text">Aggiungi Repository</span>
        </button>
      } @else {
        <!-- Form per inserire URL GitHub -->
        <div class="aside-secondary__form">
          <label class="aside-secondary__form-label" for="github-url">
            URL Repository GitHub
          </label>
          <input 
            type="url"
            id="github-url"
            class="aside-secondary__form-input"
            placeholder="https://github.com/username/repository"
            [(ngModel)]="githubUrl"
            [disabled]="saving()"
            (keyup.enter)="onSave()">
          
          @if (errorMessage()) {
            <p class="aside-secondary__form-error">{{ errorMessage() }}</p>
          }
          
          <div class="aside-secondary__form-actions">
            <button 
              type="button"
              class="aside-secondary__form-btn aside-secondary__form-btn--cancel"
              (click)="onCancel()"
              [disabled]="saving()">
              Annulla
            </button>
            <button 
              type="button"
              class="aside-secondary__form-btn aside-secondary__form-btn--save"
              (click)="onSave()"
              [disabled]="saving()">
              @if (saving()) {
                <span>Salvataggio...</span>
              } @else {
                <span>Salva</span>
              }
            </button>
          </div>
        </div>
      }
    } @else if (repositories().length === 0) {
      <!-- Empty state per utenti non autenticati senza repository -->
      <div class="aside-secondary__empty">
        <p class="aside-secondary__empty-text">Nessuna repository GitHub configurata</p>
      </div>
    }
  </div>
</div>

