<aside class="profile">
  @if (loading()) {
    <div class="aside-skeleton">
      <!-- corner placeholders for small/medium layout -->
      <div class="toggle-left-skel skeleton" aria-hidden="true"></div>
      <div class="toggle-right-skel skeleton" aria-hidden="true"></div>
      <div class="edit-right-skel skeleton" aria-hidden="true"></div>
      <div class="aside-skel-header">
        <div class="avatar-skel skeleton"></div>
        <div class="name-skel skeleton"></div>
        <div class="role-skel skeleton"></div>
      </div>

      @if (viewMode() === 'large') {
        <div class="aside-skel-contacts">
          @for (i of [0,1,2,3]; track i) {
            <div class="contact-skel">
              <div class="icon-skel skeleton" aria-hidden="true"></div>
              <div class="lines">
                <div class="skeleton h-4 w-40"></div>
                <div class="skeleton h-4 w-56"></div>
              </div>
            </div>
          }
        </div>

        <div class="aside-skel-socials">
          @for (i of [0,1,2,3]; track i) {
            <div class="social-skel skeleton" aria-hidden="true"></div>
          }
        </div>
      }
    </div>
  } @else {
  <div class="profile__header">
    <div class="avatar-wrap">
      @if (!editMode()) {
        <app-avatar [avatarData]="mainAvatarData()" [width]="120"></app-avatar>
      } @else {
        <app-avatar-editor
          [context]="'aside'"
          [editing]="editMode()"
          [width]="100"
          [height]="100"
          [initialUrl]="mainAvatarData()?.img || null"
          (avatarChange)="onAvatarEditorChange($event)">
        </app-avatar-editor>
      }
    </div>
    <div class="profile__identity">
      <h1 class="profile__name" [title]="fullName() || '—'">{{ fullName() || '—' }}</h1>
      <p class="profile__role">Full Stack Developer</p>
    </div>

    <!-- Bottone Modifica (visibile solo se l'utente può modificare questa pagina) -->
    @if (edit.canEdit()) {
      <button
        class="btn btn-sm profile__edit"
        [class.profile__edit--offset]="showContacts()"
        (click)="toggleEditMode()"
        [title]="editMode() ? 'Fine' : 'Modifica'"
        [attr.aria-label]="editMode() ? 'Fine' : 'Modifica'">
        <svg class="profile__edit-icon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM21.41 6.34a1.25 1.25 0 0 0 0-1.77l-2.98-2.98a1.25 1.25 0 0 0-1.77 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
        </svg>
        <span class="profile__edit-label">{{ editMode() ? 'Fine' : 'Modifica' }}</span>
      </button>
    }

    <!-- Toggle Tema -->
    <button
      (click)="toggleTheme($event)"
      class="btn btn-sm profile__toggle profile__theme-toggle"
      [title]="theme.isDark() ? 'Switch to Light Mode' : 'Switch to Dark Mode'"
      aria-label="Toggle theme">
      <svg xmlns="http://www.w3.org/2000/svg"
           class="icon-16"
           viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           aria-hidden="true">
        @if (theme.isDark()) {
          <path d="M12 3v1m0 16v1m9-9h1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
        } @else {
          <path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
        }
      </svg>
    </button>

    @if (showButton()) {
      <button
        (click)="toggleContacts($event)"
        class="btn btn-sm profile__toggle profile__toggle--contacts"
        [class.is-open]="showContacts()"
        [attr.aria-expanded]="showContacts()"
        aria-controls="contacts-panel">
        <!-- Un solo SVG: la rotazione è gestita da .is-open in CSS -->
        <svg xmlns="http://www.w3.org/2000/svg"
             class="icon-16 caret"
             viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
             aria-hidden="true">
          <path d="M6 9l6 6 6-6"/>
        </svg>

        @if (!isSmall()) {
          <span class="profile__toggle-label">
            {{ showContacts() ? 'Hide Contacts' : 'Show Contacts' }}
          </span>
        }
      </button>
    }
  </div>

  @if (showContacts()) {
    <div id="contacts-panel" class="contacts" @expandCollapse>
      <div class="contacts__divider" role="separator" aria-hidden="true"></div>

      <!-- Stati caricamento/errore -->
      @if (loading()) {
        <div class="contact__text">Caricamento…</div>
      }
      @if (!loading() && errorMsg()) {
        <div class="contact__text text-red-600">{{ errorMsg() }}</div>
      }

      @if (!loading() && !errorMsg()) {
        <ul class="contacts__list">
          <!-- EMAIL -->
          @if (profile()?.email) {
            <li class="contact">
              <div class="contact__icon">
                <svg class="icon-20 mute" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <rect x="3" y="5" width="18" height="14" rx="2"/>
                  <path d="M3 7l9 6 9-6"/>
                </svg>
              </div>
              <div class="contact__body">
                <p class="contact__label">Email</p>
                <a class="contact__link" [href]="emailHref()">{{ profile()?.email }}</a>
              </div>
            </li>
          }

          <!-- PHONE -->
          @if (profile()?.phone || editMode()) {
            <li class="contact" [class.contact--editable]="editMode() && !profile()?.phone">
              <div class="contact__icon">
                <svg class="icon-20 mute" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <rect x="7" y="2" width="10" height="20" rx="2" ry="2"/>
                  <line x1="12" y1="18" x2="12" y2="18"/>
                </svg>
              </div>
              <div class="contact__body">
                <p class="contact__label">Cellulare</p>
                @if (editMode() && !profile()?.phone) {
                  <input 
                    type="tel" 
                    class="contact__input" 
                    placeholder="Inserisci numero"
                    [(ngModel)]="tempPhone"
                    (blur)="savePhone()"
                    (keyup.enter)="savePhone()" />
                } @else {
                  <a class="contact__link" [href]="phoneHref()">{{ profile()?.phone }}</a>
                }
              </div>
            </li>
          }

          <!-- CALENDAR / BIRTHDAY -->
          @if (birthdayHuman() || editMode()) {
            <li class="contact" [class.contact--editable]="editMode() && !birthdayHuman()">
              <div class="contact__icon">
                <svg class="icon-20 mute" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <rect x="3" y="4" width="18" height="18" rx="2"/>
                  <line x1="16" y1="2" x2="16" y2="6"/>
                  <line x1="8" y1="2" x2="8" y2="6"/>
                  <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
              </div>
              <div class="contact__body">
                <p class="contact__label">Compleanno</p>
                @if (editMode() && !birthdayHuman()) {
                  <input 
                    type="date" 
                    class="contact__input" 
                    [(ngModel)]="tempBirthday"
                    (blur)="saveBirthday()"
                    (keyup.enter)="saveBirthday()" />
                } @else {
                  <time class="contact__text" [attr.datetime]="birthdayISO() ?? undefined">
                    {{ birthdayHuman() }}
                  </time>
                }
              </div>
            </li>
          }

          <!-- LOCATION -->
          @if (locationTxt() || editMode()) {
            <li class="contact" [class.contact--editable]="editMode() && !locationTxt()" 
                [attr.role]="editMode() && !locationTxt() ? null : 'button'" 
                [attr.tabindex]="editMode() && !locationTxt() ? null : '0'" 
                (click)="editMode() && !locationTxt() ? null : goToContacts()">
              <div class="contact__icon">
                <svg class="icon-20 mute" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <path d="M12 21s-6-5.686-6-10a6 6 0 1 1 12 0c0 4.314-6 10-6 10z"/>
                  <circle cx="12" cy="11" r="2.5"/>
                </svg>
              </div>
              <div class="contact__body">
                <p class="contact__label">Posizione</p>
                @if (editMode() && !locationTxt()) {
                  <input 
                    type="text" 
                    class="contact__input" 
                    placeholder="Inserisci località"
                    [(ngModel)]="tempLocation"
                    (blur)="saveLocation()"
                    (keyup.enter)="saveLocation()" />
                } @else {
                  <address class="contact__text">{{ locationTxt() }}</address>
                }
              </div>
            </li>
          }
        </ul>

        <div class="contacts__divider" role="separator" aria-hidden="true"></div>

      <!-- GESTIONE OFFERTE LAVORATIVE (solo per utenti autenticati) -->
        @if (isAuthed()) {
          <ul class="contacts__list contacts__list--single">
            <li class="contact contact--job-offers" role="button" tabindex="0" (click)="goToJobOffers()">
              <div class="contact__icon">
                <svg class="icon-20 mute" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                  <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
                </svg>
              </div>
              <div class="contact__body">
                <p class="contact__label">Offerte Lavorative</p>
                <span class="contact__text">Gestisci candidature</span>
              </div>
            </li>
          </ul>

          <div class="contacts__divider" role="separator" aria-hidden="true"></div>
        }

      <!-- SOCIAL DINAMICI -->
        <ul class="socials">
          @for (s of socials(); track s.provider) {
            <li>
              <a class="contact__icon" [href]="s.url!" target="_blank" rel="noopener" [attr.aria-label]="s.provider">
                @switch (iconKind(s.provider)) {
                  @case ('facebook') {
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-20 mute hover-unmute" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                      <path d="M22 12a10 10 0 1 0-11.6 9.9v-7H8v-3h2.4V9.8c0-2.4 1.4-3.8 3.6-3.8 1 0 2 .2 2 .2v2.2h-1.1c-1.1 0-1.4.7-1.4 1.3V12h2.4l-.4 3h-2v6.9A10 10 0 0 0 22 12z"/>
                    </svg>
                  }
                  @case ('instagram') {
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-20 mute hover-unmute" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <rect x="3" y="3" width="18" height="18" rx="5"/>
                      <circle cx="12" cy="12" r="3.5"/>
                      <circle cx="17.5" cy="6.5" r="1"/>
                    </svg>
                  }
                  @case ('github') {
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-20 mute hover-unmute" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                      <path d="M12 .5a12 12 0 0 0-3.8 23.4c.6.1.8-.3.8-.6v-2c-3.4.7-4.1-1.6-4.1-1.6-.6-1.5-1.5-1.9-1.5-1.9-1.2-.8.1-.8.1-.8 1.3.1 2 1.4 2 1.4 1.2 2 3.1 1.4 3.9 1.1.1-.9.5-1.4.8-1.7-2.7-.3-5.6-1.4-5.6-6.2 0-1.4.5-2.6 1.3-3.6-.1-.3-.6-1.7.1-3.5 0 0 1.1-.4 3.7 1.3a12.9 12.9 0 0 1 6.6 0c2.6-1.7 3.7-1.3 3.7-1.3.7 1.8.2 3.2.1 3.5.8 1 1.3 2.2 1.3 3.6 0 4.8-2.9 5.9-5.6 6.2.5.4.9 1.1.9 2.2v3.3c0 .3.2.7.9.6A12 12 0 0 0 12 .5z"/>
                    </svg>
                  }
                  @case ('linkedin') {
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-20 mute hover-unmute" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                      <path d="M4.98 3.5A2.5 2.5 0 1 0 5 8.5a2.5 2.5 0 0 0-.02-5zM4 9h3.1v12H4zM10 9h3v1.6h.1A3.3 3.3 0 0 1 16.9 9c3 0 3.6 2 3.6 4.5V21H17V14.7c0-1.5 0-3.3-2-3.3s-2.3 1.6-2.3 3.2V21H10z"/>
                    </svg>
                  }
                  @case ('x') {
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-20 mute hover-unmute" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                      <path d="M4 4l8 8L4 20h3l8-8-8-8H4zm13 0h3l-6.5 6.5L21 20h-3l-6.5-6.5L17 4z"/>
                    </svg>
                  }
                  @case ('youtube') {
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-20 mute hover-unmute" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                      <path d="M23 7.5s-.2-1.6-.8-2.3c-.7-.8-1.5-.8-1.9-.9C17.7 4 12 4 12 4h0s-5.7 0-8.3.3c-.4 0-1.2.1-1.9.9C1.2 5.9 1 7.5 1 7.5S.8 9.4.8 11.4v1.2C.8 14.6 1 16.5 1 16.5s.2 1.6.8 2.3c.7.8 1.6.8 2 1 1.5.2 8.2.3 8.2.3s5.7 0 8.3-.3c.4 0 1.2-.1 1.9-.9.6-.7.8-2.3.8-2.3s.2-1.9.2-3.9v-1.2c0-2-.2-3.9-.2-3.9zM9.8 14.9V7.9l6.2 3.5-6.2 3.5z"/>
                    </svg>
                  }
                  @default {
                    <!-- Fallback globe -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon-20 mute hover-unmute" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <circle cx="12" cy="12" r="10"/>
                      <path d="M2 12h20M12 2a15.3 15.3 0 0 1 0 20M12 2a15.3 15.3 0 0 0 0 20"/>
                    </svg>
                  }
                }
              </a>
            </li>
          }
          
          <!-- WhatsApp dal numero, se presente -->
          @if (whatsappHref() && profile()?.phone) {
            <li>
              <a class="contact__icon" [href]="whatsappHref()!" target="_blank" rel="noopener" aria-label="Whatsapp">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon-20 mute hover-unmute" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                </svg>
              </a>
            </li>
          }
        </ul>
      }
    </div>
  }
  }
</aside>