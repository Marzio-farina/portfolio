<div class="card-wrapper"
     (mouseenter)="play()" (mouseleave)="pause()"
     (click)="onCardClick()"
     [class.is-deleting]="deleting()"
     [attr.aria-busy]="deleting()"
     [style.--hover-rotate]="hoverRotate()"
     [style.--hover-translate]="hoverTranslate()"
     [style.--hover-scale]="hoverScale()"
     [style.--hover-shadow]="hoverShadow()"
     [style.--hover-meta-bg]="hoverMetaBackgroundColor()"
     [style.--radial-gradient-color]="radialGradientColor()"
     role="button"
     tabindex="0"
     [attr.aria-label]="'Apri dettagli progetto: ' + progetto().title">
  @if (isAuthenticated() && isEditing()) {
    <button class="admin-x-btn"
            type="button"
            [class.is-cancel]="deleting()"
            [attr.aria-label]="deleting() ? 'Annulla eliminazione progetto' : 'Elimina progetto'"
            [attr.title]="deleting() ? 'Annulla eliminazione' : 'Elimina progetto'"
            (click)="onAdminButtonClick($event)">
      <span aria-hidden="true">{{ deleting() ? '↩' : '×' }}</span>
    </button>
  }
  @if (deleting()) {
    <div class="card-deletion-overlay" aria-hidden="true">
      <div class="card-deletion-skeleton"></div>
    </div>
  }
  <div class="card" [class.no-video]="!progetto().video">
    <div class="media">
      <!-- Usa NgOptimizedImage con fill mode per gestire aspect ratio variabili -->
      <img 
        class="poster" 
        [ngSrc]="progetto().poster" 
        [alt]="progetto().title"
        fill
        [priority]="priority()"
        sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw">
      <video 
        #videoEl 
        class="video" 
        [src]="progetto().video" 
        muted 
        playsinline 
        preload="none"
        loop>
      </video>
    </div>
  </div>
  <div class="meta">
    <h3 class="title">{{ progetto().title }}</h3>
    @if (isAuthenticated() && isEditing()) {
      <mat-form-field class="category-select-field" (click)="onSelectClick($event)">
        <mat-select 
          [value]="getCurrentCategoryId()"
          [disabled]="changingCategory()"
          (selectionChange)="onCategorySelectionChange($event.value)"
          class="category-select-mat"
          panelClass="category-select-panel">
          @for (cat of categories(); track cat.id) {
            <mat-option [value]="cat.id">
              {{ cat.title }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>
    } @else {
      <p class="category">{{ progetto().category }}</p>
    }
    @if (progetto().technologies && progetto().technologies.length > 0) {
      <div class="technologies" (click)="$event.stopPropagation()">
        @if (hiddenTechsCount() > 0) {
          <div class="more-techs-wrapper" (mouseleave)="closeHiddenTechsPopup()">
            <button 
              class="more-techs-badge" 
              type="button" 
              [attr.aria-label]="'Mostra ' + hiddenTechsCount() + ' tecnologie nascoste'"
              (click)="toggleHiddenTechsPopup($event)"
              (mouseenter)="openHiddenTechsPopup($event)">
              +{{ hiddenTechsCount() }}
            </button>
            @if (showHiddenTechsPopup()) {
              <div 
                class="hidden-techs-popup"
                [style.top]="popupTop()"
                [style.left]="popupLeft()">
                @for (tech of hiddenTechs(); track tech.id) {
                  <div 
                    class="hidden-tech-item"
                    [class.others]="tech.isOthers"
                    [attr.title]="tech.isOthers ? 'Tecnologie rimanenti non visualizzate' : tech.title">
                    {{ tech.title }}
                  </div>
                }
              </div>
            }
          </div>
        }
        @for (tech of visibleTechs(); track tech.id) {
          <span class="technology-tag" [title]="tech.title">{{ tech.title }}</span>
        }
        @if (isAuthenticated() && isEditing()) {
          @if (!isAddTechExpanded()) {
            <button 
              class="add-tech-btn" 
              type="button" 
              aria-label="Aggiungi tecnologie"
              (click)="onExpandAddTech($event)">
              <span aria-hidden="true">+</span>
            </button>
          } @else {
            <div class="add-tech-expanded" (click)="$event.stopPropagation()">
              <input
                type="text"
                class="add-tech-input"
                [value]="newTechValue()"
                [disabled]="addingTechnology()"
                (input)="onTechInput($event)"
                (keydown)="onTechSubmit($event)"
                (blur)="onTechBlur()"
                (click)="$event.stopPropagation()"
                placeholder="Nome tecnologia..."
                maxlength="50">
            </div>
          }
        }
      </div>
    } @else {
      @if (isAuthenticated() && isEditing()) {
        <div class="technologies" (click)="$event.stopPropagation()">
          @if (!isAddTechExpanded()) {
            <button 
              class="add-tech-btn" 
              type="button" 
              aria-label="Aggiungi tecnologie"
              (click)="onExpandAddTech($event)">
              <span aria-hidden="true">+</span>
            </button>
          } @else {
            <div class="add-tech-expanded" (click)="$event.stopPropagation()">
              <input
                type="text"
                class="add-tech-input"
                [value]="newTechValue()"
                [disabled]="addingTechnology()"
                (input)="onTechInput($event)"
                (keydown)="onTechSubmit($event)"
                (blur)="onTechBlur()"
                (click)="$event.stopPropagation()"
                placeholder="Nome tecnologia..."
                maxlength="50">
            </div>
          }
        </div>
      }
    }
  </div>
</div>