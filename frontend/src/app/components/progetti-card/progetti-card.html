<div class="card-wrapper"
     (mouseenter)="play()" (mouseleave)="pause()"
     (click)="onCardClick()"
     [style.--hover-rotate]="hoverRotate()"
     [style.--hover-translate]="hoverTranslate()"
     [style.--hover-scale]="hoverScale()"
     [style.--hover-shadow]="hoverShadow()"
     [style.--hover-meta-bg]="hoverMetaBackgroundColor()"
     [style.--radial-gradient-color]="radialGradientColor()"
     role="button"
     tabindex="0"
     [attr.aria-label]="'Apri dettagli progetto: ' + progetto().title">
  @if (isAuthenticated() && isEditing()) {
    <button class="admin-x-btn" type="button" aria-label="Elimina progetto" (click)="onAdminButtonClick($event)">
      <span aria-hidden="true">Ã—</span>
    </button>
  }
  <div class="card" [class.no-video]="!progetto().video">
    <div class="media"><img class="poster" [src]="progetto().poster" alt="{{ progetto().title }}"><video #videoEl class="video" [src]="progetto().video" muted playsinline preload="metadata" loop></video></div>
  </div>
  <div class="meta">
    <h3 class="title">{{ progetto().title }}</h3>
    @if (isAuthenticated() && isEditing()) {
      <mat-form-field class="category-select-field" (click)="onSelectClick($event)">
        <mat-select 
          [value]="getCurrentCategoryId()"
          [disabled]="changingCategory()"
          (selectionChange)="onCategorySelectionChange($event.value)"
          class="category-select-mat"
          panelClass="category-select-panel">
          @for (cat of categories(); track cat.id) {
            <mat-option [value]="cat.id">
              {{ cat.title }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>
    } @else {
      <p class="category">{{ progetto().category }}</p>
    }
    @if (progetto().technologies && progetto().technologies.length > 0) {
      <div class="technologies" (click)="$event.stopPropagation()">
        @if (hiddenTechsCount() > 0) {
          <div class="more-techs-wrapper">
            <button 
              class="more-techs-badge" 
              type="button" 
              [attr.aria-label]="'Mostra ' + hiddenTechsCount() + ' tecnologie nascoste'"
              (click)="toggleHiddenTechsPopup($event)">
              +{{ hiddenTechsCount() }}
            </button>
            @if (showHiddenTechsPopup()) {
              <div class="hidden-techs-popup" (mouseleave)="closeHiddenTechsPopup()">
                @for (tech of hiddenTechs(); track tech.id) {
                  <div class="hidden-tech-item">{{ tech.title }}</div>
                }
              </div>
            }
          </div>
        }
        @for (tech of visibleTechs(); track tech.id) {
          <span class="technology-tag" [title]="tech.title">{{ tech.title }}</span>
        }
        @if (isAuthenticated() && isEditing()) {
          @if (!isAddTechExpanded()) {
            <button 
              class="add-tech-btn" 
              type="button" 
              aria-label="Aggiungi tecnologie"
              (click)="onExpandAddTech($event)">
              <span aria-hidden="true">+</span>
            </button>
          } @else {
            <div class="add-tech-expanded" (click)="$event.stopPropagation()">
              <input
                type="text"
                class="add-tech-input"
                [value]="newTechValue()"
                (input)="onTechInput($event)"
                (keydown)="onTechSubmit($event)"
                (blur)="onTechBlur()"
                (click)="$event.stopPropagation()"
                placeholder="Nome tecnologia..."
                maxlength="50">
            </div>
          }
        }
      </div>
    } @else {
      @if (isAuthenticated() && isEditing()) {
        <div class="technologies" (click)="$event.stopPropagation()">
          @if (!isAddTechExpanded()) {
            <button 
              class="add-tech-btn" 
              type="button" 
              aria-label="Aggiungi tecnologie"
              (click)="onExpandAddTech($event)">
              <span aria-hidden="true">+</span>
            </button>
          } @else {
            <div class="add-tech-expanded" (click)="$event.stopPropagation()">
              <input
                type="text"
                class="add-tech-input"
                [value]="newTechValue()"
                (input)="onTechInput($event)"
                (keydown)="onTechSubmit($event)"
                (blur)="onTechBlur()"
                (click)="$event.stopPropagation()"
                placeholder="Nome tecnologia..."
                maxlength="50">
            </div>
          }
        </div>
      }
    }
  </div>
</div>