<!-- Sistema di notifiche per feedback tecnologie -->
<app-notification 
  [notifications]="notifications()"
  [showMultiple]="showMultipleNotifications"
  [mostSevereNotification]="getMostSevereNotification()">
</app-notification>

<div class="card-wrapper"
     (mouseenter)="play()" 
     (mouseleave)="onCardMouseLeave()"
     (click)="onCardClick()"
     [class.is-deleting]="deleting()"
     [attr.aria-busy]="deleting()"
     [style.--hover-rotate]="hoverRotate()"
     [style.--hover-translate]="hoverTranslate()"
     [style.--hover-scale]="hoverScale()"
     [style.--hover-shadow]="hoverShadow()"
     [style.--hover-meta-bg]="hoverMetaBackgroundColor()"
     [style.--radial-gradient-color]="radialGradientColor()"
     role="button"
     tabindex="0"
     [attr.aria-label]="'Apri dettagli progetto: ' + (progetto().title || 'Progetto')">
  @if (isAuthenticated() && isEditing()) {
    <app-admin-delete-button
      [isDeleting]="deleting()"
      deleteLabel="Elimina progetto"
      cancelLabel="Annulla eliminazione progetto"
      (buttonClick)="onAdminButtonClick($event)">
    </app-admin-delete-button>
  }
  @if (deleting()) {
    <app-deletion-overlay [blurAmount]="12" />
  }
  <div class="card" [class.no-video]="!progetto().video">
    <div class="media">
      <!-- Usa NgOptimizedImage con fill mode per gestire aspect ratio variabili -->
      <!-- Wrappato in @if basato su priority per evitare errori quando l'indice cambia -->
      @if (progetto() && progetto().poster && progetto().poster.length > 0) {
        @if (priority()) {
          <img 
            class="poster" 
            [ngSrc]="progetto().poster" 
            [alt]="progetto().title || 'Project image'"
            fill
            priority
            fetchpriority="high"
            sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw">
        } @else {
          <img 
            class="poster" 
            [ngSrc]="progetto().poster" 
            [alt]="progetto().title || 'Project image'"
            fill
            loading="lazy"
            sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw">
        }
      }
      @if (progetto() && progetto().video && progetto().video.length > 0) {
        <video 
          #videoEl 
          class="video" 
          [src]="progetto().video" 
          muted 
          playsinline 
          preload="none"
          loading="lazy"
          loop>
        </video>
      }
    </div>
  </div>
  <div class="meta">
    <h3 class="title">{{ progetto().title || 'Progetto' }}</h3>
    @if (isAuthenticated() && isEditing()) {
      <mat-form-field class="category-select-field" (click)="onSelectClick($event)">
        <mat-select 
          [value]="getCurrentCategoryId()"
          [disabled]="changingCategory()"
          (selectionChange)="onCategorySelectionChange($event.value)"
          class="category-select-mat"
          panelClass="category-select-panel">
          @for (cat of categories(); track cat.id) {
            <mat-option [value]="cat.id">
              {{ cat.title }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>
    } @else {
      <p class="category">{{ progetto().category || 'Categoria' }}</p>
    }
    @if (progetto().technologies && progetto().technologies.length > 0) {
      <div class="technologies" (click)="$event.stopPropagation()">
        @if (hiddenTechsCount() > 0) {
          <div class="more-techs-wrapper">
            <button 
              class="more-techs-badge" 
              type="button" 
              [attr.aria-label]="'Mostra ' + hiddenTechsCount() + ' tecnologie nascoste'"
              (click)="toggleHiddenTechsPopup($event)"
              (mouseenter)="openHiddenTechsPopup($event)">
              +{{ hiddenTechsCount() }}
            </button>
            @if (showHiddenTechsPopup()) {
              <div 
                class="hidden-techs-popup"
                [style.bottom]="popupBottom()"
                [style.left]="popupLeft()">
                @for (tech of hiddenTechs(); track trackByTech($index, tech)) {
                  @if (isEditingTech(tech)) {
                    <!-- Input inline per modifica nel popup -->
                    <input
                      type="text"
                      class="hidden-tech-item hidden-tech-item-editing"
                      [value]="techEditValue()"
                      (input)="onTechEditInput($event)"
                      (keydown)="onTechEditKeydown($event, tech)"
                      (blur)="onTechEditBlur(tech)"
                      (click)="$event.stopPropagation()"
                      placeholder="Nome tecnologia..."
                      maxlength="50">
                  } @else {
                    <div 
                      class="hidden-tech-item"
                      [class.others]="tech.isOthers"
                      [class.optimistic]="isOptimisticTech(tech)"
                      [class.removing]="isRemovingTech(tech)"
                      [attr.title]="tech.isOthers ? 'Tecnologie rimanenti non visualizzate' : tech.title"
                      (dblclick)="onTechDoubleClick($event, tech)">
                      {{ tech.isOthers ? tech.title : truncateTechTitle(tech.title!) }}
                    </div>
                  }
                }
              </div>
            }
          </div>
        }
        @for (tech of visibleTechs(); track trackByTech($index, tech)) {
          @if (isEditingTech(tech)) {
            <!-- Input inline per modifica -->
            <input
              type="text"
              class="technology-tag technology-tag-editing"
              [value]="techEditValue()"
              (input)="onTechEditInput($event)"
              (keydown)="onTechEditKeydown($event, tech)"
              (blur)="onTechEditBlur(tech)"
              (click)="$event.stopPropagation()"
              placeholder="Nome tecnologia..."
              maxlength="50"
              #techEditInput>
          } @else {
            <span 
              class="technology-tag" 
              [class.optimistic]="isOptimisticTech(tech)"
              [class.removing]="isRemovingTech(tech)"
              [title]="tech.title"
              (dblclick)="onTechDoubleClick($event, tech)">
              {{ truncateTechTitle(tech.title) }}
            </span>
          }
        }
        @if (isAuthenticated() && isEditing()) {
          @if (!isAddTechExpanded()) {
            <button 
              class="add-tech-btn" 
              type="button" 
              aria-label="Aggiungi tecnologie"
              (click)="onExpandAddTech($event)">
              <span aria-hidden="true">+</span>
            </button>
          } @else {
            <div class="add-tech-expanded" (click)="$event.stopPropagation()">
              <input
                type="text"
                class="add-tech-input"
                [value]="newTechValue()"
                (input)="onTechInput($event)"
                (keydown)="onTechSubmit($event)"
                (blur)="onTechBlur()"
                (click)="$event.stopPropagation()"
                placeholder="Nome tecnologia..."
                maxlength="50">
            </div>
          }
        }
      </div>
    } @else {
      @if (isAuthenticated() && isEditing()) {
        <div class="technologies" (click)="$event.stopPropagation()">
          @if (!isAddTechExpanded()) {
            <button 
              class="add-tech-btn" 
              type="button" 
              aria-label="Aggiungi tecnologie"
              (click)="onExpandAddTech($event)">
              <span aria-hidden="true">+</span>
            </button>
          } @else {
            <div class="add-tech-expanded" (click)="$event.stopPropagation()">
              <input
                type="text"
                class="add-tech-input"
                [value]="newTechValue()"
                (input)="onTechInput($event)"
                (keydown)="onTechSubmit($event)"
                (blur)="onTechBlur()"
                (click)="$event.stopPropagation()"
                placeholder="Nome tecnologia..."
                maxlength="50">
            </div>
          }
        </div>
      }
    }
  </div>
</div>