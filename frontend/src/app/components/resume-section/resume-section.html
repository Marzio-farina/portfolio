<section class="section">
  <header class="section__header">
    <button
      class="section__icon"
      type="button"
      (click)="toggle()"
      [attr.aria-label]="'Espandi o riduci sezione ' + title()"
      [attr.aria-expanded]="isOpen() ? 'true' : 'false'"
      [attr.aria-controls]="id() + '-panel'">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path [attr.d]="iconPath"></path>
      </svg>
    </button>

    <h3 [id]="id() + '-title'" class="section__title-text">
      {{ title() }}
    </h3>
    
    <button
      class="section__title"
      type="button"
      (click)="toggle()"
      [attr.aria-expanded]="isOpen() ? 'true' : 'false'"
      [attr.aria-controls]="id() + '-panel'"
      [attr.aria-label]="'Espandi o riduci sezione ' + title()"
      [attr.aria-labelledby]="id() + '-title'">
      <span aria-hidden="true">{{ isOpen() ? '▼' : '▶' }}</span>
    </button>
  </header>

  <div 
    class="section__panel" 
    [id]="id() + '-panel'" 
    [class.is-open]="isOpen()"
    role="region"
    [attr.aria-labelledby]="id() + '-title'">
    <ol class="timeline" [class.timeline--empty]="!hasItems()">
      @if (hasItems()) {
        <!-- Se ci sono items, mostra button '+' tra di loro se in edit mode -->
        @for (it of items(); track it.title + '-' + it.years; let idx = $index) {
          <!-- Button '+' prima dell'item (quando canEdit è true e non si sta già aggiungendo in questa posizione) -->
          @if (canEdit()) {
            @if (isAdding() && editingIndex() === -1 && insertPosition() === idx) {
              <!-- Form di aggiunta nella posizione corretta -->
              <li class="timeline__item timeline__item--editing">
                <!-- Icona chevron per chiudere il form -->
                <button 
                  class="timeline__toggle-editing" 
                  type="button"
                  (click)="resetForm()"
                  aria-label="Chiudi form">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="timeline__toggle-icon">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                </button>
                
                <div class="timeline__content">
                  <h4 class="timeline__title" contenteditable="true" 
                      (blur)="onTitleBlur($event)"
                      (input)="onTitleInput($event)"
                      placeholder="Titolo..."></h4>
                  
                  <div class="timeline__years">
                    <input 
                      type="date" 
                      class="timeline__date-input"
                      [(ngModel)]="tempStartDate"
                      (ngModelChange)="resetInactivityTimer()"
                      (focus)="resetInactivityTimer()"
                      (click)="resetInactivityTimer()"
                      placeholder="Data inizio">
                    <span class="timeline__date-separator">—</span>
                    <input 
                      type="date" 
                      class="timeline__date-input"
                      [(ngModel)]="tempEndDate"
                      [disabled]="isInCorso()"
                      (ngModelChange)="resetInactivityTimer()"
                      (focus)="resetInactivityTimer()"
                      (click)="resetInactivityTimer()"
                      placeholder="Data fine">
                    <label class="timeline__checkbox">
                      <input 
                        type="checkbox" 
                        [checked]="isInCorso()"
                        (change)="toggleInCorso()">
                      <span>In Corso</span>
                    </label>
                  </div>
                  
                  <p class="timeline__description" contenteditable="true"
                     (blur)="onDescriptionBlur($event)"
                     (input)="onDescriptionInput($event)"
                     placeholder="Descrizione..."></p>
                </div>
              </li>
            } @else if (!isAdding() || editingIndex() >= 0) {
              <!-- Button '+' per aggiungere prima di questo item (solo se non si sta già aggiungendo) -->
              <li class="timeline__add-between">
                <button 
                  type="button" 
                  class="timeline__add-btn-small"
                  (click)="startAdd(idx)"
                  [attr.aria-label]="'Aggiungi ' + title() + ' prima di ' + it.title">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 5v14M5 12h14"/>
                  </svg>
                </button>
              </li>
            }
          }
          
          <!-- Item esistente o form di modifica -->
          @if (editingIndex() === idx) {
            <!-- Form di modifica per questo item -->
            <li class="timeline__item timeline__item--editing">
              <!-- Icona chevron per chiudere il form -->
              <button 
                class="timeline__toggle-editing" 
                type="button"
                (click)="resetForm()"
                aria-label="Chiudi form">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="timeline__toggle-icon">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
              
              <div class="timeline__content">
                <h4 class="timeline__title" contenteditable="true" 
                    (blur)="onTitleBlur($event)"
                    (input)="onTitleInput($event)"
                    placeholder="Titolo..."></h4>
                
                <div class="timeline__years">
                  <input 
                    type="date" 
                    class="timeline__date-input"
                    [(ngModel)]="tempStartDate"
                    (ngModelChange)="resetInactivityTimer()"
                    (focus)="resetInactivityTimer()"
                    (click)="resetInactivityTimer()"
                    placeholder="Data inizio">
                  <span class="timeline__date-separator">—</span>
                  <input 
                    type="date" 
                    class="timeline__date-input"
                    [(ngModel)]="tempEndDate"
                    [disabled]="isInCorso()"
                    (ngModelChange)="resetInactivityTimer()"
                    (focus)="resetInactivityTimer()"
                    (click)="resetInactivityTimer()"
                    placeholder="Data fine">
                  <label class="timeline__checkbox">
                    <input 
                      type="checkbox" 
                      [checked]="isInCorso()"
                      (change)="toggleInCorso()">
                    <span>In Corso</span>
                  </label>
                </div>
                
                <p class="timeline__description" contenteditable="true"
                   (blur)="onDescriptionBlur($event)"
                   (input)="onDescriptionInput($event)"
                   placeholder="Descrizione..."></p>
              </div>
            </li>
          } @else {
            <!-- Item esistente -->
            <li class="timeline__item">
              <app-timeline-item
                [title]="it.title"
                [years]="it.years"
                [description]="it.description"
                [canEdit]="canEdit()"
                (delete)="onDelete(it)"
                (edit)="onEdit(it, idx)">
              </app-timeline-item>
            </li>
          }
        }
        
        <!-- Button '+' alla fine della lista (se in edit mode) -->
        @if (canEdit()) {
          @if (isAdding() && editingIndex() === -1 && insertPosition() === items().length) {
            <!-- Form di aggiunta alla fine -->
            <li class="timeline__item timeline__item--editing">
              <!-- Icona chevron per chiudere il form -->
              <button 
                class="timeline__toggle-editing" 
                type="button"
                (click)="resetForm()"
                aria-label="Chiudi form">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="timeline__toggle-icon">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
              
              <div class="timeline__content">
                <h4 class="timeline__title" contenteditable="true" 
                    (blur)="onTitleBlur($event)"
                    (input)="onTitleInput($event)"
                    placeholder="Titolo..."></h4>
                
                <div class="timeline__years">
                  <input 
                    type="date" 
                    class="timeline__date-input"
                    [(ngModel)]="tempStartDate"
                    (ngModelChange)="resetInactivityTimer()"
                    (focus)="resetInactivityTimer()"
                    (click)="resetInactivityTimer()"
                    placeholder="Data inizio">
                  <span class="timeline__date-separator">—</span>
                  <input 
                    type="date" 
                    class="timeline__date-input"
                    [(ngModel)]="tempEndDate"
                    [disabled]="isInCorso()"
                    (ngModelChange)="resetInactivityTimer()"
                    (focus)="resetInactivityTimer()"
                    (click)="resetInactivityTimer()"
                    placeholder="Data fine">
                  <label class="timeline__checkbox">
                    <input 
                      type="checkbox" 
                      [checked]="isInCorso()"
                      (change)="toggleInCorso()">
                    <span>In Corso</span>
                  </label>
                </div>
                
                <p class="timeline__description" contenteditable="true"
                   (blur)="onDescriptionBlur($event)"
                   (input)="onDescriptionInput($event)"
                   placeholder="Descrizione..."></p>
              </div>
            </li>
          } @else if (!isAdding() || editingIndex() >= 0) {
            <!-- Button '+' per aggiungere alla fine (solo se non si sta già aggiungendo) -->
            <li class="timeline__add-between">
              <button 
                type="button" 
                class="timeline__add-btn-small"
                (click)="startAdd(items().length)"
                [attr.aria-label]="'Aggiungi ' + title() + ' alla fine'">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 5v14M5 12h14"/>
                </svg>
              </button>
            </li>
          }
        }
      } @else {
        @if (canEdit()) {
          @if (!isAdding()) {
            <!-- Pulsante per aggiungere nuovo elemento in modalità edit -->
            <li class="timeline__add-container">
              <button 
                type="button" 
                class="timeline__add-btn"
                (click)="startAdd()"
                [attr.aria-label]="'Aggiungi ' + title()">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 5v14M5 12h14"/>
                </svg>
                <span>Aggiungi {{ title() }}</span>
              </button>
            </li>
          } @else {
            <!-- Elemento timeline editabile inline (espansione del pulsante) -->
            <li class="timeline__item timeline__item--editing">
              <!-- Icona chevron per chiudere il form -->
              <button 
                class="timeline__toggle-editing" 
                type="button"
                (click)="resetForm()"
                aria-label="Chiudi form">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="timeline__toggle-icon">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
              
              <div class="timeline__content">
                <h4 class="timeline__title" contenteditable="true" 
                    (blur)="onTitleBlur($event)"
                    (input)="onTitleInput($event)"
                    placeholder="Titolo..."></h4>
                
                <div class="timeline__years">
                  <input 
                    type="date" 
                    class="timeline__date-input"
                    [(ngModel)]="tempStartDate"
                    (ngModelChange)="resetInactivityTimer()"
                    (focus)="resetInactivityTimer()"
                    (click)="resetInactivityTimer()"
                    placeholder="Data inizio">
                  <span class="timeline__date-separator">—</span>
                  <input 
                    type="date" 
                    class="timeline__date-input"
                    [(ngModel)]="tempEndDate"
                    [disabled]="isInCorso()"
                    (ngModelChange)="resetInactivityTimer()"
                    (focus)="resetInactivityTimer()"
                    (click)="resetInactivityTimer()"
                    placeholder="Data fine">
                  <label class="timeline__checkbox">
                    <input 
                      type="checkbox" 
                      [checked]="isInCorso()"
                      (change)="toggleInCorso()">
                    <span>In Corso</span>
                  </label>
                </div>
                
                <p class="timeline__description" contenteditable="true"
                   (blur)="onDescriptionBlur($event)"
                   (input)="onDescriptionInput($event)"
                   placeholder="Descrizione..."></p>
              </div>
            </li>
          }
        } @else {
          <!-- Messaggio per utenti non in edit mode -->
          <li class="timeline__empty-message">
            Nessun dato inserito
          </li>
        }
      }
    </ol>
  </div>
</section>