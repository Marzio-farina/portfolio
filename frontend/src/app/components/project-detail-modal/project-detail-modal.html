<app-notification
  [notifications]="notifications()"
  [showMultiple]="false"
  [mostSevereNotification]="getMostSevereNotification()">
</app-notification>

<div class="project-detail-modal">
  <!-- Pulsante chiusura posizionato in modo assoluto -->
  <button 
    type="button"
    class="project-detail-modal__close" 
    (click)="onClose()" 
    aria-label="Chiudi">
    ×
  </button>

  <!-- Contenuto scrollabile unico -->
  <div class="project-detail-modal__scrollable">
    <!-- Titolo all'interno del contenuto scrollabile -->
    @if (canEdit()) {
      <input 
        type="text"
        [formControl]="$any(editForm.get('title'))"
        class="project-detail-modal__title-input"
        placeholder="Titolo progetto"
        maxlength="50">
    } @else {
      <h2 class="project-detail-modal__title">{{ project().title }}</h2>
    }
    <form [formGroup]="editForm">
      <!-- Input file nascosti per upload immagine e video -->
      @if (canEdit()) {
        <input 
          #posterInput
          type="file" 
          accept="image/jpeg,image/png,image/jpg,image/gif,image/webp"
          (change)="onPosterFileSelected($event)"
          style="display: none;">
        <input 
          #videoInput
          type="file" 
          accept="video/mp4,video/webm,video/ogg"
          (change)="onVideoFileSelected($event)"
          style="display: none;">
      }

      <!-- Immagine con area tratteggiata in edit mode -->
      @if (project().poster && !imageLoadError()) {
        <div 
          class="project-detail-modal__image" 
          [class.image-vertical]="isVerticalImage()"
          [class.project-detail-modal__image--editable]="canEdit()">
          <div 
            class="project-detail-modal__image-container"
            [style.width.px]="containerWidth()"
            [style.height.px]="containerHeight"
            (dragover)="onDragOverPoster($event)"
            (dragleave)="onDragLeavePoster($event)"
            (drop)="onFileDropPoster($event)"
            [class.is-dragover]="isDragOverPoster()">
            <img
              [src]="getPosterUrl()"
              [alt]="project().title"
              (load)="onImgLoad($event)"
              (error)="onImgError($event)"
              class="project-detail-modal__image-img"
            />
            @if (canEdit()) {
              <button 
                type="button"
                class="project-detail-modal__change-media"
                (click)="openPosterPicker()"
                [disabled]="saving()"
                aria-label="Cambia immagine">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM21.41 6.34a1.25 1.25 0 0 0 0-1.77l-2.98-2.98a1.25 1.25 0 0 0-1.77 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
              </button>
            }
          </div>
        </div>
      } @else if (imageLoadError()) {
        <div class="project-detail-modal__image-error">
          <p>Immagine non disponibile</p>
          @if (canEdit()) {
            <button 
              type="button"
              class="project-detail-modal__add-media-btn"
              (click)="openPosterPicker()">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M21 19V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
              </svg>
              <span>Carica immagine</span>
            </button>
          }
        </div>
      } @else if (canEdit() && !project().poster) {
        <div class="project-detail-modal__add-image-area">
          <button 
            type="button"
            class="project-detail-modal__add-media-btn"
            (click)="openPosterPicker()"
            (dragover)="onDragOverPoster($event)"
            (dragleave)="onDragLeavePoster($event)"
            (drop)="onFileDropPoster($event)"
            [class.is-dragover]="isDragOverPoster()">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M21 19V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
            </svg>
            <span>Carica immagine</span>
          </button>
        </div>
      }

      <!-- Video con area tratteggiata in edit mode -->
      @if (project().video || getVideoUrl()) {
        <div 
          class="project-detail-modal__video"
          [class.project-detail-modal__video--editable]="canEdit()">
          <div 
            class="project-detail-modal__video-container"
            (dragover)="onDragOverVideo($event)"
            (dragleave)="onDragLeaveVideo($event)"
            (drop)="onFileDropVideo($event)"
            [class.is-dragover]="isDragOverVideo()">
            <div class="project-detail-modal__video-wrapper">
              <video
                [src]="getVideoUrl() || project().video"
                controls
                class="project-detail-modal__video-element"
                (click)="onVideoClick($event)"
                (loadstart)="onVideoLoadStart($event)"
                (progress)="onVideoProgress($event)"
                (loadeddata)="onVideoLoadedData($event)"
                (error)="onVideoError($event)">
                Il tuo browser non supporta il tag video.
              </video>
              @if (videoLoading()) {
                <div class="project-detail-modal__video-loading">
                  <div class="project-detail-modal__video-progress-bar">
                    <div 
                      class="project-detail-modal__video-progress-fill"
                      [style.width.%]="videoLoadProgress()">
                    </div>
                  </div>
                  <span class="project-detail-modal__video-progress-text">{{ videoLoadProgress() }}%</span>
                </div>
              }
            </div>
            @if (canEdit()) {
              <button 
                type="button"
                class="project-detail-modal__change-media"
                (click)="openVideoPicker()"
                [disabled]="saving()"
                aria-label="Cambia video">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM21.41 6.34a1.25 1.25 0 0 0 0-1.77l-2.98-2.98a1.25 1.25 0 0 0-1.77 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
              </button>
              <button 
                type="button"
                class="project-detail-modal__remove-video admin-x-btn"
                (click)="removeVideo()"
                [disabled]="saving()"
                aria-label="Rimuovi video">
                <span aria-hidden="true">×</span>
              </button>
            }
          </div>
        </div>
      } @else if (canEdit()) {
        <div class="project-detail-modal__add-video-area">
          <button 
            type="button"
            class="project-detail-modal__add-media-btn"
            (click)="openVideoPicker()"
            (dragover)="onDragOverVideo($event)"
            (dragleave)="onDragLeaveVideo($event)"
            (drop)="onFileDropVideo($event)"
            [class.is-dragover]="isDragOverVideo()">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M8 5v14l11-7z"/>
            </svg>
            <span>Carica video</span>
          </button>
        </div>
      }

      <div class="project-detail-modal__info">
        <div class="project-detail-modal__field">
          <span class="project-detail-modal__label">Categoria:</span>
          @if (canEdit()) {
            <select 
              formControlName="category_id"
              class="project-detail-modal__value-input">
              <option value="">Seleziona categoria</option>
              @for (cat of categories(); track cat.id) {
                <option [value]="cat.id">{{ cat.title }}</option>
              }
            </select>
          } @else {
            @if (project().category) {
              <span class="project-detail-modal__value">{{ project().category }}</span>
            }
          }
        </div>

        <div class="project-detail-modal__field">
          <span class="project-detail-modal__label">Tecnologie:</span>
          @if (canEdit()) {
            @if (loadingTechnologies()) {
              <span class="project-detail-modal__value">Caricamento tecnologie...</span>
            } @else {
              @if (availableTechnologies().length > 0) {
                <div class="project-detail-modal__technologies-selector">
                  @for (tech of availableTechnologies(); track tech.id) {
                    <label class="project-detail-modal__tech-checkbox">
                      <input 
                        type="checkbox"
                        [checked]="isTechnologySelected(tech.id)"
                        (change)="toggleTechnology(tech.id)"
                        class="project-detail-modal__tech-input">
                      <span class="project-detail-modal__tech-label">{{ tech.title }}</span>
                    </label>
                  }
                </div>
              } @else {
                <span class="project-detail-modal__value project-detail-modal__value--empty">Nessuna tecnologia disponibile</span>
              }
            }
          } @else {
            @if (project().technologies && project().technologies.length > 0) {
              <div class="project-detail-modal__tags">
                @for (tech of project().technologies; track tech.id) {
                  <span class="project-detail-modal__tag">{{ tech.title }}</span>
                }
              </div>
            } @else {
              <span class="project-detail-modal__value project-detail-modal__value--empty">Nessuna tecnologia specificata</span>
            }
          }
        </div>

        <div class="project-detail-modal__field">
          <span class="project-detail-modal__label">Descrizione: <span class="project-detail-modal__required">*</span></span>
          @if (canEdit()) {
            <textarea 
              formControlName="description"
              class="project-detail-modal__value-input project-detail-modal__textarea"
              placeholder="Descrizione progetto"
              maxlength="1000"
              rows="4"></textarea>
          } @else {
            @if (project().description) {
              <p class="project-detail-modal__description">{{ project().description }}</p>
            }
          }
        </div>
      </div>

      @if (canEdit()) {
        <div class="project-detail-modal__actions project-detail-modal__actions--mobile">
          <button 
            type="button"
            class="project-detail-modal__btn project-detail-modal__btn--cancel"
            (click)="onCancel()"
            [disabled]="saving()">
            Annulla
          </button>
          <button 
            type="button"
            class="project-detail-modal__btn project-detail-modal__btn--save"
            (click)="onSave()"
            [disabled]="saving() || editForm.invalid">
            @if (saving()) {
              <span>Salvataggio...</span>
            } @else {
              <span>Salva</span>
            }
          </button>
        </div>
      }
    </form>
  </div>

  <!-- Versione desktop: pulsanti fuori dal dialog -->
  @if (canEdit()) {
    <div class="project-detail-modal__actions project-detail-modal__actions--desktop">
      <button 
        type="button"
        class="project-detail-modal__btn project-detail-modal__btn--cancel"
        (click)="onCancel()"
        [disabled]="saving()">
        Annulla
      </button>
      <button 
        type="button"
        class="project-detail-modal__btn project-detail-modal__btn--save"
        (click)="onSave()"
        [disabled]="saving() || editForm.invalid">
        @if (saving()) {
          <span>Salvataggio...</span>
        } @else {
          <span>Salva</span>
        }
      </button>
    </div>
  }
</div>
