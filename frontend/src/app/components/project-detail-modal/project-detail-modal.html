<app-notification
  [notifications]="notifications()"
  [showMultiple]="true"
  [mostSevereNotification]="getMostSevereNotification()">
</app-notification>

<div 
  class="project-detail-modal">
  <!-- Pulsante chiusura -->
  <button 
    type="button"
    class="project-detail-modal__close" 
    (click)="onClose()" 
    aria-label="Chiudi">
    √ó
  </button>


  <!-- Contenuto scrollabile -->
  <div class="project-detail-modal__scrollable">
    <!-- Titolo fisso (non movibile) -->
    <div class="project-detail-modal__title-wrapper">
      @if (isEditMode()) {
        <input 
          type="text"
          [formControl]="$any(editForm.get('title'))"
          class="project-detail-modal__title-input"
          placeholder="Titolo progetto"
          maxlength="50">
      } @else {
        <h2 class="project-detail-modal__title">{{ project().title }}</h2>
      }
    </div>

    <!-- Canvas con griglia per elementi posizionabili -->
    <div 
      class="project-detail-modal__canvas"
      [class.edit-mode]="isEditMode()"
      [class.is-creating]="canvasService.isCreatingElement()"
      [class.creating-text]="canvasService.isCreatingElement() === 'text'"
      [class.creating-image]="canvasService.isCreatingElement() === 'image'"
      [style.min-height.px]="canvasHeight()"
      (mousemove)="canvasService.isCreatingElement() ? onCanvasMouseMove($event) : null"
      (mousedown)="canvasService.isCreatingElement() ? onCanvasMouseDown($event) : null"
      (mouseup)="canvasService.isCreatingElement() ? onCanvasMouseUp($event) : null"
      (mouseleave)="canvasService.isCreatingElement() ? cancelElementCreation() : null">
      
      <!-- Overlay per disegno elemento -->
      @if (canvasService.isCreatingElement()) {
        <!-- Cursore personalizzato -->
        <div 
          class="custom-cursor"
          [style.left.px]="canvasService.cursorPos().x"
          [style.top.px]="canvasService.cursorPos().y">
          @if (canvasService.isCreatingElement() === 'text') {
            <span class="custom-cursor__icon">T</span>
          } @else {
            <span class="custom-cursor__icon">üñºÔ∏è</span>
          }
        </div>
        
        <!-- Rettangolo di disegno -->
        @if (canvasService.drawStartPos() && canvasService.drawCurrentPos()) {
          <div 
            class="draw-rectangle"
            [style.left.px]="Math.min(canvasService.drawStartPos()!.x, canvasService.drawCurrentPos()!.x)"
            [style.top.px]="Math.min(canvasService.drawStartPos()!.y, canvasService.drawCurrentPos()!.y)"
            [style.width.px]="Math.abs(canvasService.drawCurrentPos()!.x - canvasService.drawStartPos()!.x)"
            [style.height.px]="Math.abs(canvasService.drawCurrentPos()!.y - canvasService.drawStartPos()!.y)">
          </div>
        }
      }
      
      <!-- Overlay che mostra l'area visibile del dispositivo (solo in edit mode) -->
      @if (isEditMode()) {
        <div 
          class="device-viewport-indicator"
          [style.width.px]="canvasService.selectedDevice().width"
          [style.height.px]="viewportHeight()">
          
          <!-- Linea che indica l'altezza originale del dispositivo (se espanso) -->
          @if (viewportHeight() > canvasService.selectedDevice().height) {
            <div 
              class="device-original-height-line"
              [style.top.px]="canvasService.selectedDevice().height"
              [style.width.px]="canvasService.selectedDevice().width"></div>
          }
        </div>
      }
      
      <!-- ELEMENTO 1: Immagine -->
      <div 
        class="canvas-item"
        [class.is-dragging]="canvasService.dragState().isDragging && canvasService.dragState().draggedItemId === 'image'"
        [class.is-resizing]="canvasService.resizeState().isResizing && canvasService.resizeState().itemId === 'image'"
        [class.outside-viewport]="isItemOutsideViewport('image')"
        [style.left.px]="getItemStyle('image').left"
        [style.top.px]="getItemStyle('image').top"
        [style.width.px]="getItemStyle('image').width"
        [style.height.px]="getItemStyle('image').height"
        (mousedown)="onItemMouseDown($event, 'image')">
        
        <app-poster-uploader
          [posterUrl]="project().poster"
          [projectTitle]="project().title"
          [isEditMode]="isEditMode()"
          [saving]="saving()"
          (posterSelected)="onPosterSelected($event)"
          (aspectRatioCalculated)="onAspectRatioCalculated($event)">
        </app-poster-uploader>

        <!-- Resize handles -->
        @if (isEditMode()) {
          <div class="resize-handle resize-e" (mousedown)="onResizeHandleMouseDown($event, 'image', 'e')"></div>
          <div class="resize-handle resize-s" (mousedown)="onResizeHandleMouseDown($event, 'image', 's')"></div>
          <div class="resize-handle resize-w" (mousedown)="onResizeHandleMouseDown($event, 'image', 'w')"></div>
          <div class="resize-handle resize-n" (mousedown)="onResizeHandleMouseDown($event, 'image', 'n')"></div>
          <div class="resize-handle resize-ne" (mousedown)="onResizeHandleMouseDown($event, 'image', 'ne')"></div>
          <div class="resize-handle resize-nw" (mousedown)="onResizeHandleMouseDown($event, 'image', 'nw')"></div>
          <div class="resize-handle resize-se" (mousedown)="onResizeHandleMouseDown($event, 'image', 'se')"></div>
          <div class="resize-handle resize-sw" (mousedown)="onResizeHandleMouseDown($event, 'image', 'sw')"></div>
        }
      </div>

      <!-- ELEMENTO 2: Video (opzionale) -->
      @if ((project().video || isEditMode()) && canvasService.canvasItems().has('video')) {
        <!-- Wrapper esterno per posizionamento -->
        <div 
          class="canvas-item-wrapper canvas-item-wrapper--video"
          [class.is-dragging]="canvasService.dragState().isDragging && canvasService.dragState().draggedItemId === 'video'"
          [class.outside-viewport]="isItemOutsideViewport('video')"
          [style.left.px]="getItemStyle('video').left"
          [style.top.px]="getItemStyle('video').top"
          [style.width.px]="getItemStyle('video').width"
          [style.height.px]="getItemStyle('video').height">
          
          <!-- Canvas item interno con bordi -->
          <div 
            class="canvas-item"
            [class.is-resizing]="canvasService.resizeState().isResizing && canvasService.resizeState().itemId === 'video'"
            (mousedown)="onItemMouseDown($event, 'video')">
          
          <app-video-uploader
            [videoUrl]="project().video"
            [isEditMode]="isEditMode()"
            [saving]="saving()"
            (videoSelected)="onVideoSelected($event)">
          </app-video-uploader>
        </div>

          <!-- X rimozione video (fuori canvas-item, dentro wrapper) -->
          @if (isEditMode() && project().video) {
            <button 
              type="button"
              class="project-detail-modal__remove-video admin-x-btn"
              (click)="onVideoRemoved(); $event.preventDefault(); $event.stopPropagation();"
              (mousedown)="$event.stopPropagation(); $event.preventDefault();"
              [disabled]="saving()"
              aria-label="Rimuovi video">
              <span aria-hidden="true">√ó</span>
            </button>
          }

          <!-- Resize handles sul wrapper -->
          @if (isEditMode()) {
            <div class="resize-handle resize-e" (mousedown)="onResizeHandleMouseDown($event, 'video', 'e')"></div>
            <div class="resize-handle resize-s" (mousedown)="onResizeHandleMouseDown($event, 'video', 's')"></div>
            <div class="resize-handle resize-w" (mousedown)="onResizeHandleMouseDown($event, 'video', 'w')"></div>
            <div class="resize-handle resize-n" (mousedown)="onResizeHandleMouseDown($event, 'video', 'n')"></div>
            <div class="resize-handle resize-ne" (mousedown)="onResizeHandleMouseDown($event, 'video', 'ne')"></div>
            <div class="resize-handle resize-nw" (mousedown)="onResizeHandleMouseDown($event, 'video', 'nw')"></div>
            <div class="resize-handle resize-se" (mousedown)="onResizeHandleMouseDown($event, 'video', 'se')"></div>
            <div class="resize-handle resize-sw" (mousedown)="onResizeHandleMouseDown($event, 'video', 'sw')"></div>
          }
        </div>
      }

      <!-- ELEMENTO 3: Categoria -->
      <div 
        class="canvas-item"
        [class.is-dragging]="canvasService.dragState().isDragging && canvasService.dragState().draggedItemId === 'category'"
        [class.is-resizing]="canvasService.resizeState().isResizing && canvasService.resizeState().itemId === 'category'"
        [class.outside-viewport]="isItemOutsideViewport('category')"
        [style.left.px]="getItemStyle('category').left"
        [style.top.px]="getItemStyle('category').top"
        [style.width.px]="getItemStyle('category').width"
        [style.height.px]="getItemStyle('category').height"
        (mousedown)="onItemMouseDown($event, 'category')">
        
        <app-category-field
          [selectedCategoryId]="editForm.get('category_id')?.value || ''"
          [categories]="categories()"
          [currentCategory]="project().category || ''"
          [isEditMode]="isEditMode()"
          [loading]="loadingCategories()"
          (categoryChanged)="editForm.get('category_id')?.setValue($event)">
        </app-category-field>

        @if (isEditMode()) {
          <div class="resize-handle resize-e" (mousedown)="onResizeHandleMouseDown($event, 'category', 'e')"></div>
          <div class="resize-handle resize-s" (mousedown)="onResizeHandleMouseDown($event, 'category', 's')"></div>
          <div class="resize-handle resize-w" (mousedown)="onResizeHandleMouseDown($event, 'category', 'w')"></div>
          <div class="resize-handle resize-n" (mousedown)="onResizeHandleMouseDown($event, 'category', 'n')"></div>
          <div class="resize-handle resize-ne" (mousedown)="onResizeHandleMouseDown($event, 'category', 'ne')"></div>
          <div class="resize-handle resize-nw" (mousedown)="onResizeHandleMouseDown($event, 'category', 'nw')"></div>
          <div class="resize-handle resize-se" (mousedown)="onResizeHandleMouseDown($event, 'category', 'se')"></div>
          <div class="resize-handle resize-sw" (mousedown)="onResizeHandleMouseDown($event, 'category', 'sw')"></div>
        }
      </div>

      <!-- ELEMENTO 4: Tecnologie -->
      @if (canvasService.canvasItems().has('technologies')) {
        <div 
          class="canvas-item"
          [class.is-dragging]="canvasService.dragState().isDragging && canvasService.dragState().draggedItemId === 'technologies'"
          [class.is-resizing]="canvasService.resizeState().isResizing && canvasService.resizeState().itemId === 'technologies'"
          [class.outside-viewport]="isItemOutsideViewport('technologies')"
          [style.left.px]="getItemStyle('technologies').left"
          [style.top.px]="getItemStyle('technologies').top"
          [style.width.px]="getItemStyle('technologies').width"
          [style.height.px]="getItemStyle('technologies').height"
          (mousedown)="onItemMouseDown($event, 'technologies')">
        
        <app-technologies-selector
          [availableTechnologies]="availableTechnologies()"
          [selectedTechnologyIds]="selectedTechnologyIds()"
          [projectTechnologies]="project().technologies || []"
          [isEditMode]="isEditMode()"
          [loading]="loadingTechnologies()"
          (technologyToggled)="toggleTechnology($event)">
        </app-technologies-selector>

        @if (isEditMode()) {
          <div class="resize-handle resize-e" (mousedown)="onResizeHandleMouseDown($event, 'technologies', 'e')"></div>
          <div class="resize-handle resize-s" (mousedown)="onResizeHandleMouseDown($event, 'technologies', 's')"></div>
          <div class="resize-handle resize-w" (mousedown)="onResizeHandleMouseDown($event, 'technologies', 'w')"></div>
          <div class="resize-handle resize-n" (mousedown)="onResizeHandleMouseDown($event, 'technologies', 'n')"></div>
          <div class="resize-handle resize-ne" (mousedown)="onResizeHandleMouseDown($event, 'technologies', 'ne')"></div>
          <div class="resize-handle resize-nw" (mousedown)="onResizeHandleMouseDown($event, 'technologies', 'nw')"></div>
          <div class="resize-handle resize-se" (mousedown)="onResizeHandleMouseDown($event, 'technologies', 'se')"></div>
          <div class="resize-handle resize-sw" (mousedown)="onResizeHandleMouseDown($event, 'technologies', 'sw')"></div>
        }
      </div>
      }

      <!-- ELEMENTO 5: Descrizione -->
      <div 
        class="canvas-item"
        [class.is-dragging]="canvasService.dragState().isDragging && canvasService.dragState().draggedItemId === 'description'"
        [class.is-resizing]="canvasService.resizeState().isResizing && canvasService.resizeState().itemId === 'description'"
        [class.outside-viewport]="isItemOutsideViewport('description')"
        [style.left.px]="getItemStyle('description').left"
        [style.top.px]="getItemStyle('description').top"
        [style.width.px]="getItemStyle('description').width"
        [style.height.px]="getItemStyle('description').height"
        (mousedown)="onItemMouseDown($event, 'description')">
        
        <app-description-field
          [description]="editForm.get('description')?.value || ''"
          [currentDescription]="project().description || ''"
          [isEditMode]="isEditMode()"
          (descriptionChanged)="editForm.get('description')?.setValue($event)">
        </app-description-field>

        @if (isEditMode()) {
          <div class="resize-handle resize-e" (mousedown)="onResizeHandleMouseDown($event, 'description', 'e')"></div>
          <div class="resize-handle resize-s" (mousedown)="onResizeHandleMouseDown($event, 'description', 's')"></div>
          <div class="resize-handle resize-w" (mousedown)="onResizeHandleMouseDown($event, 'description', 'w')"></div>
          <div class="resize-handle resize-n" (mousedown)="onResizeHandleMouseDown($event, 'description', 'n')"></div>
          <div class="resize-handle resize-ne" (mousedown)="onResizeHandleMouseDown($event, 'description', 'ne')"></div>
          <div class="resize-handle resize-nw" (mousedown)="onResizeHandleMouseDown($event, 'description', 'nw')"></div>
          <div class="resize-handle resize-se" (mousedown)="onResizeHandleMouseDown($event, 'description', 'se')"></div>
          <div class="resize-handle resize-sw" (mousedown)="onResizeHandleMouseDown($event, 'description', 'sw')"></div>
        }
      </div>

      <!-- Toolbar formattazione testo (posizionata sopra l'elemento selezionato) -->
      @if (isEditMode() && selectedCustomTextId()) {
        @for (item of customItemsArray(); track item.key) {
          @if (item.key === selectedCustomTextId() && item.value.type === 'custom-text') {
            <div 
              class="text-formatting-toolbar-wrapper"
              [style.left.px]="item.value.left"
              [style.top.px]="item.value.top - 56"
              [style.z-index]="10001"
              (mouseenter)="onToolbarMouseEnter()"
              (mouseleave)="onToolbarMouseLeave()">
              <app-text-formatting-toolbar
                [currentStyle]="getSelectedCustomTextStyle()"
                (styleChanged)="onTextStyleChanged($event)">
              </app-text-formatting-toolbar>
            </div>
          }
        }
      }
      
      <!-- ELEMENTI CUSTOM: Renderizzati dinamicamente -->
      @for (item of customItemsArray(); track item.key) {
        @if (item.value.type === 'custom-text' || item.value.type === 'custom-image') {
          <!-- Contenitore con posizionamento (senza bordi) -->
          <div 
            class="canvas-item-wrapper"
            [class.is-dragging]="canvasService.dragState().isDragging && canvasService.dragState().draggedItemId === item.key"
            [style.left.px]="item.value.left"
            [style.top.px]="item.value.top"
            [style.width.px]="item.value.width"
            [style.height.px]="item.value.height"
            [class.outside-viewport]="isItemOutsideViewport(item.key)">
            
            <!-- Contenitore del contenuto con bordi -->
            <div 
              class="canvas-item canvas-item--custom"
              [class.is-dragging]="canvasService.dragState().isDragging && canvasService.dragState().draggedItemId === item.key"
              [class.is-resizing]="canvasService.resizeState().isResizing && canvasService.resizeState().itemId === item.key"
              [class.outside-viewport]="isItemOutsideViewport(item.key)"
              [class.has-toolbar-active]="selectedCustomTextId() === item.key"
              (mousedown)="onItemMouseDown($event, item.key)">
              
              <!-- Custom Text Element -->
              @if (item.value.type === 'custom-text') {
                <app-custom-text-element
                  [elementId]="item.key"
                  [content]="item.value.content || ''"
                  [isEditMode]="isEditMode()"
                  [saving]="saving()"
                  (focused)="onCustomTextFocused(item.key)"
                  (blurred)="onCustomTextBlurred()">
                </app-custom-text-element>
              }
              
              <!-- Custom Image Element -->
              @if (item.value.type === 'custom-image') {
                <app-custom-image-element
                  [elementId]="item.key"
                  [imageUrl]="item.value.content || ''"
                  [isEditMode]="isEditMode()"
                  [saving]="saving()"
                  (imageSelected)="onCustomImageSelected(item.key, $event)">
                </app-custom-image-element>
              }
            </div>
            
            <!-- Pulsante rimozione elemento custom (fuori canvas-item, dentro wrapper) -->
            @if (isEditMode()) {
              <button 
                type="button"
                class="remove-custom-element"
                (click)="onCustomElementRemoveRequested(item.key); $event.preventDefault(); $event.stopPropagation();"
                (mousedown)="$event.stopPropagation(); $event.preventDefault();"
                [disabled]="saving()"
                title="Rimuovi elemento">
                √ó
              </button>
            }
            
            <!-- Resize handles sul wrapper esterno -->
            @if (isEditMode()) {
              <div class="resize-handle resize-e" (mousedown)="onResizeHandleMouseDown($event, item.key, 'e')"></div>
              <div class="resize-handle resize-s" (mousedown)="onResizeHandleMouseDown($event, item.key, 's')"></div>
              <div class="resize-handle resize-w" (mousedown)="onResizeHandleMouseDown($event, item.key, 'w')"></div>
              <div class="resize-handle resize-n" (mousedown)="onResizeHandleMouseDown($event, item.key, 'n')"></div>
              <div class="resize-handle resize-ne" (mousedown)="onResizeHandleMouseDown($event, item.key, 'ne')"></div>
              <div class="resize-handle resize-nw" (mousedown)="onResizeHandleMouseDown($event, item.key, 'nw')"></div>
              <div class="resize-handle resize-se" (mousedown)="onResizeHandleMouseDown($event, item.key, 'se')"></div>
              <div class="resize-handle resize-sw" (mousedown)="onResizeHandleMouseDown($event, item.key, 'sw')"></div>
            }
          </div>
        }
      }
    </div>

    <!-- Pulsanti azioni mobile (fissi, non movibili) -->
    @if (canEdit()) {
      <div class="project-detail-modal__actions project-detail-modal__actions--mobile">
        <button 
          type="button"
          class="project-detail-modal__btn project-detail-modal__btn--preview project-detail-modal__btn--preview-mobile"
          (click)="togglePreviewMode()"
          title="Anteprima senza modalit√† edit">
          @if (isPreviewMode()) {
            <span>üîô Edit</span>
          } @else {
            <span>üëÅÔ∏è</span>
          }
        </button>
        <button 
          type="button"
          class="project-detail-modal__btn project-detail-modal__btn--cancel"
          (click)="onCancel()"
          [disabled]="saving()">
          Annulla
        </button>
        <button 
          type="button"
          class="project-detail-modal__btn project-detail-modal__btn--save"
          (click)="onSave()"
          [disabled]="saving() || editForm.invalid">
          @if (saving()) {
            <span>Salvataggio...</span>
          } @else {
            <span>Salva</span>
          }
        </button>
      </div>
    }
  </div>

  <!-- Selettore dispositivi desktop (fuori dal dialog, in alto) -->
  @if (canEdit() && !isPreviewMode()) {
    <div class="project-detail-modal__devices-bar">
      <app-device-selector
        [selectedDevice]="canvasService.selectedDevice()"
        [devicePresets]="canvasService.devicePresets"
        (deviceSelected)="onDeviceSelected($event)">
      </app-device-selector>
    </div>
  }

  <!-- Toolbar per aggiungere elementi custom -->
  @if (canEdit() && !isPreviewMode()) {
    <div 
      class="add-elements-toolbar"
      [class.add-elements-toolbar--expanded]="isAddToolbarExpanded()"
      (click)="toggleAddToolbar()">
      
      <!-- Icona edit quando compatto -->
      @if (!isAddToolbarExpanded()) {
        <div class="add-elements-toolbar__icon">
          ‚úèÔ∏è
        </div>
      }
      
      <!-- Pulsanti quando espanso -->
      @if (isAddToolbarExpanded()) {
        <button 
          type="button"
          class="add-element-btn"
          (click)="addCustomText(); $event.stopPropagation()"
          title="Aggiungi testo">
          <span class="add-element-btn__icon">üìù</span>
          <span class="add-element-btn__label">Testo</span>
        </button>
        <button 
          type="button"
          class="add-element-btn"
          (click)="addCustomImage(); $event.stopPropagation()"
          title="Aggiungi immagine">
          <span class="add-element-btn__icon">üñºÔ∏è</span>
          <span class="add-element-btn__label">Immagine</span>
        </button>
        @if (!project().video) {
          <button 
            type="button"
            class="add-element-btn"
            (click)="addVideoElement(); $event.stopPropagation()"
            title="Aggiungi video">
            <span class="add-element-btn__icon">üé¨</span>
            <span class="add-element-btn__label">Video</span>
          </button>
        }
      }
    </div>
  }

  <!-- Pulsanti azioni desktop (fuori dal dialog, a destra) -->
  @if (canEdit()) {
    <div class="project-detail-modal__actions project-detail-modal__actions--desktop">
      <!-- Riga: Preview, Annulla e Salva affiancati -->
      <div class="project-detail-modal__actions-row">
        <button 
          type="button"
          class="project-detail-modal__btn project-detail-modal__btn--preview"
          (click)="togglePreviewMode()"
          title="Anteprima senza modalit√† edit">
          @if (isPreviewMode()) {
            <span>üîô</span>
          } @else {
            <span>üëÅÔ∏è</span>
          }
        </button>
        <button 
          type="button"
          class="project-detail-modal__btn project-detail-modal__btn--cancel"
          (click)="onCancel()"
          [disabled]="saving()">
          Annulla
        </button>
        <button 
          type="button"
          class="project-detail-modal__btn project-detail-modal__btn--save"
          (click)="onSave()"
          [disabled]="saving() || editForm.invalid">
          @if (saving()) {
            <span>Salvataggio...</span>
          } @else {
            <span>Salva</span>
          }
        </button>
      </div>
    </div>
  }

</div>
