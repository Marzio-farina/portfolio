<app-notification
  [notifications]="notifications()"
  [showMultiple]="false"
  [mostSevereNotification]="getMostSevereNotification()">
</app-notification>

<div 
  class="project-detail-modal">
  <!-- Pulsante chiusura -->
  <button 
    type="button"
    class="project-detail-modal__close" 
    (click)="onClose()" 
    aria-label="Chiudi">
    √ó
  </button>

  <!-- Input file nascosti -->
  @if (canEdit()) {
    <input 
      #posterInput
      type="file" 
      accept="image/jpeg,image/png,image/jpg,image/gif,image/webp"
      (change)="onPosterFileSelected($event)"
      style="display: none;">
    <input 
      #videoInput
      type="file" 
      accept="video/mp4,video/webm,video/ogg"
      (change)="onVideoFileSelected($event)"
      style="display: none;">
  }

  <!-- Contenuto scrollabile -->
  <div class="project-detail-modal__scrollable">
    <!-- Titolo fisso (non movibile) -->
    <div class="project-detail-modal__title-wrapper">
      @if (isEditMode()) {
        <input 
          type="text"
          [formControl]="$any(editForm.get('title'))"
          class="project-detail-modal__title-input"
          placeholder="Titolo progetto"
          maxlength="50">
      } @else {
        <h2 class="project-detail-modal__title">{{ project().title }}</h2>
      }
    </div>

    <!-- Canvas con griglia per elementi posizionabili -->
    <div 
      class="project-detail-modal__canvas"
      [class.edit-mode]="isEditMode()"
      [style.min-height.px]="canvasHeight()">
      
      <!-- Overlay che mostra l'area visibile del dispositivo (solo in edit mode) -->
      @if (isEditMode()) {
        <div 
          class="device-viewport-indicator"
          [style.width.px]="selectedDevice().width"
          [style.height.px]="viewportHeight()">
          
          <!-- Linea che indica l'altezza originale del dispositivo (se espanso) -->
          @if (viewportHeight() > selectedDevice().height) {
            <div 
              class="device-original-height-line"
              [style.top.px]="selectedDevice().height"
              [style.width.px]="selectedDevice().width"></div>
          }
        </div>
      }
      
      <!-- ELEMENTO 1: Immagine -->
      <div 
        class="canvas-item"
        [class.is-dragging]="dragState().isDragging && dragState().draggedItemId === 'image'"
        [class.is-resizing]="resizeState().isResizing && resizeState().itemId === 'image'"
        [class.outside-viewport]="isItemOutsideViewport('image')"
        [style.left.px]="getItemStyle('image').left"
        [style.top.px]="getItemStyle('image').top"
        [style.width.px]="getItemStyle('image').width"
        [style.height.px]="getItemStyle('image').height"
        (mousedown)="onItemMouseDown($event, 'image')">
        
        @if (project().poster && !imageLoadError()) {
          <div 
            class="project-detail-modal__image"
            [class.image-vertical]="isVerticalImage()"
            [class.project-detail-modal__image--editable]="isEditMode()">
            <div 
              class="project-detail-modal__image-container"
              (dragover)="onDragOverPoster($event)"
              (dragleave)="onDragLeavePoster($event)"
              (drop)="onFileDropPoster($event)"
              [class.is-dragover]="isDragOverPoster()">
              <img
                [src]="getPosterUrl()"
                [alt]="project().title"
                (load)="onImgLoad($event)"
                (error)="onImgError($event)"
                class="project-detail-modal__image-img" />
              
              <!-- Overlay drag drop -->
              @if (isDragOverPoster() && isEditMode()) {
                <div class="drag-drop-overlay">
                  <svg class="drag-drop-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                  </svg>
                  <span>Rilascia per caricare</span>
                </div>
              }
              
              <!-- Pulsante centrale per caricare immagine (appare all'hover) -->
              @if (isEditMode() && !isDragOverPoster()) {
                <button 
                  type="button"
                  class="upload-image-center-btn"
                  (click)="openPosterPicker()"
                  (mousedown)="$event.stopPropagation()"
                  [disabled]="saving()"
                  title="Carica o cambia immagine">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                  <span>Carica immagine</span>
                </button>
              }
            </div>
          </div>
        } @else if (imageLoadError()) {
          <div 
            class="project-detail-modal__image-error"
            (dragover)="onDragOverPoster($event)"
            (dragleave)="onDragLeavePoster($event)"
            (drop)="onFileDropPoster($event)"
            [class.is-dragover]="isDragOverPoster()">
            <p>Immagine non disponibile</p>
            
            @if (isEditMode()) {
              <!-- Overlay drag drop -->
              @if (isDragOverPoster()) {
                <div class="drag-drop-overlay">
                  <svg class="drag-drop-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                  </svg>
                  <span>Rilascia per caricare</span>
                </div>
              } @else {
                <!-- Pulsante centrale all'hover -->
                <button 
                  type="button"
                  class="upload-image-center-btn"
                  (click)="openPosterPicker()"
                  (mousedown)="$event.stopPropagation()"
                  [disabled]="saving()"
                  title="Carica immagine">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                  <span>Carica immagine</span>
                </button>
              }
            }
          </div>
        } @else if (isEditMode() && !project().poster) {
          <div 
            class="project-detail-modal__add-image-area"
            (dragover)="onDragOverPoster($event)"
            (dragleave)="onDragLeavePoster($event)"
            (drop)="onFileDropPoster($event)"
            [class.is-dragover]="isDragOverPoster()">
            
            <!-- Overlay drag drop -->
            @if (isDragOverPoster()) {
              <div class="drag-drop-overlay">
                <svg class="drag-drop-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                <span>Rilascia per caricare</span>
              </div>
            } @else {
              <!-- Pulsante centrale sempre visibile quando vuoto -->
              <button 
                type="button"
                class="upload-image-center-btn"
                (click)="openPosterPicker()"
                (mousedown)="$event.stopPropagation()"
                [disabled]="saving()"
                title="Carica immagine">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <span>Carica immagine</span>
              </button>
            }
          </div>
        }

        <!-- Resize handles -->
        @if (isEditMode()) {
          <div class="resize-handle resize-e" (mousedown)="onResizeHandleMouseDown($event, 'image', 'e')"></div>
          <div class="resize-handle resize-s" (mousedown)="onResizeHandleMouseDown($event, 'image', 's')"></div>
          <div class="resize-handle resize-w" (mousedown)="onResizeHandleMouseDown($event, 'image', 'w')"></div>
          <div class="resize-handle resize-n" (mousedown)="onResizeHandleMouseDown($event, 'image', 'n')"></div>
          <div class="resize-handle resize-ne" (mousedown)="onResizeHandleMouseDown($event, 'image', 'ne')"></div>
          <div class="resize-handle resize-nw" (mousedown)="onResizeHandleMouseDown($event, 'image', 'nw')"></div>
          <div class="resize-handle resize-se" (mousedown)="onResizeHandleMouseDown($event, 'image', 'se')"></div>
          <div class="resize-handle resize-sw" (mousedown)="onResizeHandleMouseDown($event, 'image', 'sw')"></div>
        }
      </div>

      <!-- ELEMENTO 2: Video (opzionale) -->
      @if (project().video || getVideoUrl() || isEditMode()) {
        <!-- Wrapper esterno per posizionamento -->
        <div 
          class="canvas-item-wrapper canvas-item-wrapper--video"
          [class.is-dragging]="dragState().isDragging && dragState().draggedItemId === 'video'"
          [class.outside-viewport]="isItemOutsideViewport('video')"
          [style.left.px]="getItemStyle('video').left"
          [style.top.px]="getItemStyle('video').top"
          [style.width.px]="getItemStyle('video').width"
          [style.height.px]="getItemStyle('video').height">
          
          <!-- Canvas item interno con bordi -->
          <div 
            class="canvas-item"
            [class.is-resizing]="resizeState().isResizing && resizeState().itemId === 'video'"
            (mousedown)="onItemMouseDown($event, 'video')">
          
          @if (project().video || getVideoUrl()) {
            <div 
              class="project-detail-modal__video"
              [class.project-detail-modal__video--editable]="isEditMode()">
              <div 
                class="project-detail-modal__video-container"
                (dragover)="onDragOverVideo($event)"
                (dragleave)="onDragLeaveVideo($event)"
                (drop)="onFileDropVideo($event)"
                [class.is-dragover]="isDragOverVideo()">
                <div class="project-detail-modal__video-wrapper">
                  <video
                    [src]="getVideoUrl() || project().video"
                    controls
                    class="project-detail-modal__video-element"
                    (click)="onVideoClick($event)"
                    (loadstart)="onVideoLoadStart($event)"
                    (progress)="onVideoProgress($event)"
                    (loadeddata)="onVideoLoadedData($event)"
                    (error)="onVideoError($event)">
                    Il tuo browser non supporta il tag video.
                  </video>
                  @if (videoLoading()) {
                    <div class="project-detail-modal__video-loading">
                      <div class="project-detail-modal__video-progress-bar">
                        <div 
                          class="project-detail-modal__video-progress-fill"
                          [style.width.%]="videoLoadProgress()">
                        </div>
                      </div>
                      <span class="project-detail-modal__video-progress-text">{{ videoLoadProgress() }}%</span>
                    </div>
                  }
                </div>
                @if (isEditMode()) {
                  <button 
                    type="button"
                    class="project-detail-modal__change-media"
                    (click)="openVideoPicker()"
                    [disabled]="saving()"
                    aria-label="Cambia video">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM21.41 6.34a1.25 1.25 0 0 0 0-1.77l-2.98-2.98a1.25 1.25 0 0 0-1.77 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                  </button>
                }
              </div>
            </div>
          } @else if (isEditMode()) {
            <div class="project-detail-modal__add-video-area">
              <button 
                type="button"
                class="project-detail-modal__add-media-btn"
                (click)="openVideoPicker()"
                (dragover)="onDragOverVideo($event)"
                (dragleave)="onDragLeaveVideo($event)"
                (drop)="onFileDropVideo($event)"
                [class.is-dragover]="isDragOverVideo()">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M8 5v14l11-7z"/>
                </svg>
                <span>Carica video</span>
              </button>
            </div>
          }
        </div>

          <!-- X rimozione video (fuori canvas-item, dentro wrapper) -->
          @if (isEditMode() && (project().video || getVideoUrl())) {
            <button 
              type="button"
              class="project-detail-modal__remove-video admin-x-btn"
              (click)="removeVideo()"
              (mousedown)="$event.stopPropagation()"
              [disabled]="saving()"
              aria-label="Rimuovi video">
              <span aria-hidden="true">√ó</span>
            </button>
          }

          <!-- Resize handles sul wrapper -->
          @if (isEditMode()) {
            <div class="resize-handle resize-e" (mousedown)="onResizeHandleMouseDown($event, 'video', 'e')"></div>
            <div class="resize-handle resize-s" (mousedown)="onResizeHandleMouseDown($event, 'video', 's')"></div>
            <div class="resize-handle resize-w" (mousedown)="onResizeHandleMouseDown($event, 'video', 'w')"></div>
            <div class="resize-handle resize-n" (mousedown)="onResizeHandleMouseDown($event, 'video', 'n')"></div>
            <div class="resize-handle resize-ne" (mousedown)="onResizeHandleMouseDown($event, 'video', 'ne')"></div>
            <div class="resize-handle resize-nw" (mousedown)="onResizeHandleMouseDown($event, 'video', 'nw')"></div>
            <div class="resize-handle resize-se" (mousedown)="onResizeHandleMouseDown($event, 'video', 'se')"></div>
            <div class="resize-handle resize-sw" (mousedown)="onResizeHandleMouseDown($event, 'video', 'sw')"></div>
          }
        </div>
      }

      <!-- ELEMENTO 3: Categoria -->
      <div 
        class="canvas-item"
        [class.is-dragging]="dragState().isDragging && dragState().draggedItemId === 'category'"
        [class.is-resizing]="resizeState().isResizing && resizeState().itemId === 'category'"
        [class.outside-viewport]="isItemOutsideViewport('category')"
        [style.left.px]="getItemStyle('category').left"
        [style.top.px]="getItemStyle('category').top"
        [style.width.px]="getItemStyle('category').width"
        [style.height.px]="getItemStyle('category').height"
        (mousedown)="onItemMouseDown($event, 'category')">
        
        <div class="project-detail-modal__field">
          <span class="project-detail-modal__label">Categoria:</span>
          @if (isEditMode()) {
            <select 
              [formControl]="$any(editForm.get('category_id'))"
              class="project-detail-modal__value-input">
              <option value="">Seleziona categoria</option>
              @for (cat of categories(); track cat.id) {
                <option [value]="cat.id">{{ cat.title }}</option>
              }
            </select>
          } @else {
            @if (project().category) {
              <span class="project-detail-modal__value">{{ project().category }}</span>
            }
          }
        </div>

        @if (isEditMode()) {
          <div class="resize-handle resize-e" (mousedown)="onResizeHandleMouseDown($event, 'category', 'e')"></div>
          <div class="resize-handle resize-s" (mousedown)="onResizeHandleMouseDown($event, 'category', 's')"></div>
          <div class="resize-handle resize-w" (mousedown)="onResizeHandleMouseDown($event, 'category', 'w')"></div>
          <div class="resize-handle resize-n" (mousedown)="onResizeHandleMouseDown($event, 'category', 'n')"></div>
          <div class="resize-handle resize-ne" (mousedown)="onResizeHandleMouseDown($event, 'category', 'ne')"></div>
          <div class="resize-handle resize-nw" (mousedown)="onResizeHandleMouseDown($event, 'category', 'nw')"></div>
          <div class="resize-handle resize-se" (mousedown)="onResizeHandleMouseDown($event, 'category', 'se')"></div>
          <div class="resize-handle resize-sw" (mousedown)="onResizeHandleMouseDown($event, 'category', 'sw')"></div>
        }
      </div>

      <!-- ELEMENTO 4: Tecnologie -->
      <div 
        class="canvas-item"
        [class.is-dragging]="dragState().isDragging && dragState().draggedItemId === 'technologies'"
        [class.is-resizing]="resizeState().isResizing && resizeState().itemId === 'technologies'"
        [class.outside-viewport]="isItemOutsideViewport('technologies')"
        [style.left.px]="getItemStyle('technologies').left"
        [style.top.px]="getItemStyle('technologies').top"
        [style.width.px]="getItemStyle('technologies').width"
        [style.height.px]="getItemStyle('technologies').height"
        (mousedown)="onItemMouseDown($event, 'technologies')">
        
        <div class="project-detail-modal__field">
          <span class="project-detail-modal__label">Tecnologie:</span>
          @if (isEditMode()) {
            @if (loadingTechnologies()) {
              <span class="project-detail-modal__value">Caricamento tecnologie...</span>
            } @else {
              @if (availableTechnologies().length > 0) {
                <div class="project-detail-modal__technologies-selector">
                  @for (tech of availableTechnologies(); track tech.id) {
                    <label class="project-detail-modal__tech-checkbox">
                      <input 
                        type="checkbox"
                        [checked]="isTechnologySelected(tech.id)"
                        (change)="toggleTechnology(tech.id)"
                        class="project-detail-modal__tech-input">
                      <span class="project-detail-modal__tech-label">{{ tech.title }}</span>
                    </label>
                  }
                </div>
              } @else {
                <span class="project-detail-modal__value project-detail-modal__value--empty">Nessuna tecnologia disponibile</span>
              }
            }
          } @else {
            @if (project().technologies && project().technologies.length > 0) {
              <div class="project-detail-modal__tags">
                @for (tech of project().technologies; track tech.id) {
                  <span class="project-detail-modal__tag">{{ tech.title }}</span>
                }
              </div>
            } @else {
              <span class="project-detail-modal__value project-detail-modal__value--empty">Nessuna tecnologia specificata</span>
            }
          }
        </div>

        @if (isEditMode()) {
          <div class="resize-handle resize-e" (mousedown)="onResizeHandleMouseDown($event, 'technologies', 'e')"></div>
          <div class="resize-handle resize-s" (mousedown)="onResizeHandleMouseDown($event, 'technologies', 's')"></div>
          <div class="resize-handle resize-w" (mousedown)="onResizeHandleMouseDown($event, 'technologies', 'w')"></div>
          <div class="resize-handle resize-n" (mousedown)="onResizeHandleMouseDown($event, 'technologies', 'n')"></div>
          <div class="resize-handle resize-ne" (mousedown)="onResizeHandleMouseDown($event, 'technologies', 'ne')"></div>
          <div class="resize-handle resize-nw" (mousedown)="onResizeHandleMouseDown($event, 'technologies', 'nw')"></div>
          <div class="resize-handle resize-se" (mousedown)="onResizeHandleMouseDown($event, 'technologies', 'se')"></div>
          <div class="resize-handle resize-sw" (mousedown)="onResizeHandleMouseDown($event, 'technologies', 'sw')"></div>
        }
      </div>

      <!-- ELEMENTO 5: Descrizione -->
      <div 
        class="canvas-item"
        [class.is-dragging]="dragState().isDragging && dragState().draggedItemId === 'description'"
        [class.is-resizing]="resizeState().isResizing && resizeState().itemId === 'description'"
        [class.outside-viewport]="isItemOutsideViewport('description')"
        [style.left.px]="getItemStyle('description').left"
        [style.top.px]="getItemStyle('description').top"
        [style.width.px]="getItemStyle('description').width"
        [style.height.px]="getItemStyle('description').height"
        (mousedown)="onItemMouseDown($event, 'description')">
        
        <div class="project-detail-modal__field">
          <span class="project-detail-modal__label">
            Descrizione: 
            @if (isEditMode()) {
              <span class="project-detail-modal__required">*</span>
            }
          </span>
          @if (isEditMode()) {
            <textarea 
              [formControl]="$any(editForm.get('description'))"
              class="project-detail-modal__value-input project-detail-modal__textarea"
              placeholder="Descrizione progetto"
              maxlength="1000"
              rows="4"></textarea>
          } @else {
            @if (project().description) {
              <p class="project-detail-modal__description">{{ project().description }}</p>
            }
          }
        </div>

        @if (isEditMode()) {
          <div class="resize-handle resize-e" (mousedown)="onResizeHandleMouseDown($event, 'description', 'e')"></div>
          <div class="resize-handle resize-s" (mousedown)="onResizeHandleMouseDown($event, 'description', 's')"></div>
          <div class="resize-handle resize-w" (mousedown)="onResizeHandleMouseDown($event, 'description', 'w')"></div>
          <div class="resize-handle resize-n" (mousedown)="onResizeHandleMouseDown($event, 'description', 'n')"></div>
          <div class="resize-handle resize-ne" (mousedown)="onResizeHandleMouseDown($event, 'description', 'ne')"></div>
          <div class="resize-handle resize-nw" (mousedown)="onResizeHandleMouseDown($event, 'description', 'nw')"></div>
          <div class="resize-handle resize-se" (mousedown)="onResizeHandleMouseDown($event, 'description', 'se')"></div>
          <div class="resize-handle resize-sw" (mousedown)="onResizeHandleMouseDown($event, 'description', 'sw')"></div>
        }
      </div>

      <!-- ELEMENTI CUSTOM: Renderizzati dinamicamente -->
      @for (item of canvasItems() | keyvalue; track item.key) {
        @if (item.value.type === 'custom-text' || item.value.type === 'custom-image') {
          <!-- Contenitore con posizionamento (senza bordi) -->
          <div 
            class="canvas-item-wrapper"
            [class.is-dragging]="dragState().isDragging && dragState().draggedItemId === item.key"
            [style.left.px]="item.value.left"
            [style.top.px]="item.value.top"
            [style.width.px]="item.value.width"
            [style.height.px]="item.value.height"
            [class.outside-viewport]="isItemOutsideViewport(item.key)">
            
            <!-- Contenitore del contenuto con bordi -->
            <div 
              class="canvas-item canvas-item--custom"
              [class.is-resizing]="resizeState().isResizing && resizeState().itemId === item.key"
              (mousedown)="onItemMouseDown($event, item.key)">
              <!-- Elemento testo custom -->
              @if (item.value.type === 'custom-text') {
                @if (isEditMode()) {
                  <textarea 
                    class="custom-text-input"
                    [value]="item.value.content || ''"
                    (input)="updateCustomElementContent(item.key, $any($event.target).value)"
                    (mousedown)="$event.stopPropagation()"
                    placeholder="Inserisci il testo."></textarea>
                } @else {
                  <div class="custom-text-display">{{ item.value.content }}</div>
                }
              }
              
              <!-- Elemento immagine custom -->
              @if (item.value.type === 'custom-image') {
                <!-- Input file nascosto per questa immagine -->
                @if (isEditMode()) {
                  <input 
                    type="file"
                    accept="image/jpeg,image/png,image/jpg,image/gif,image/webp"
                    (change)="onCustomImageFileSelected($event, item.key)"
                    style="display: none;"
                    [id]="'customImageInput-' + item.key">
                }
                
                <div 
                  class="custom-image-wrapper"
                  (dragover)="onDragOverCustomImage($event, item.key)"
                  (dragleave)="onDragLeaveCustomImage($event, item.key)"
                  (drop)="onFileDropCustomImage($event, item.key)"
                  [class.is-dragover]="customImageDragOver().get(item.key)">
                  
                  @if (item.value.content) {
                    <img 
                      [src]="item.value.content" 
                      [alt]="'Immagine custom ' + item.key"
                      class="custom-image-display">
                    
                    @if (isEditMode()) {
                      <!-- Overlay drag drop -->
                      @if (customImageDragOver().get(item.key)) {
                        <div class="drag-drop-overlay">
                          <svg class="drag-drop-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                          </svg>
                          <span>Rilascia per caricare</span>
                        </div>
                      } @else {
                        <!-- Pulsante centrale all'hover -->
                        <button 
                          type="button"
                          class="upload-image-center-btn"
                          (click)="openCustomImagePicker(item.key)"
                          (mousedown)="$event.stopPropagation()"
                          title="Carica o cambia immagine">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                          </svg>
                          <span>Cambia immagine</span>
                        </button>
                      }
                    }
                  } @else if (isEditMode()) {
                    @if (customImageDragOver().get(item.key)) {
                      <!-- Overlay drag drop per area vuota -->
                      <div class="drag-drop-overlay">
                        <svg class="drag-drop-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <span>Rilascia per caricare</span>
                      </div>
                    } @else {
                      <!-- Pulsante centrale sempre visibile quando vuoto -->
                      <button 
                        type="button"
                        class="upload-image-center-btn upload-image-center-btn--empty"
                        (click)="openCustomImagePicker(item.key)"
                        (mousedown)="$event.stopPropagation()"
                        title="Carica immagine">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span>Carica immagine</span>
                      </button>
                    }
                  }
                </div>
              }
            </div>
            
            <!-- Pulsante rimozione elemento custom (dentro wrapper, fuori contenitore interno) -->
            @if (isEditMode()) {
              <button 
                type="button"
                class="remove-custom-element"
                (click)="removeCustomElement(item.key)"
                (mousedown)="$event.stopPropagation()"
                title="Rimuovi elemento">
                √ó
              </button>
            }
            
            <!-- Resize handles sul wrapper esterno -->
            @if (isEditMode()) {
              <div class="resize-handle resize-e" (mousedown)="onResizeHandleMouseDown($event, item.key, 'e')"></div>
              <div class="resize-handle resize-s" (mousedown)="onResizeHandleMouseDown($event, item.key, 's')"></div>
              <div class="resize-handle resize-w" (mousedown)="onResizeHandleMouseDown($event, item.key, 'w')"></div>
              <div class="resize-handle resize-n" (mousedown)="onResizeHandleMouseDown($event, item.key, 'n')"></div>
              <div class="resize-handle resize-ne" (mousedown)="onResizeHandleMouseDown($event, item.key, 'ne')"></div>
              <div class="resize-handle resize-nw" (mousedown)="onResizeHandleMouseDown($event, item.key, 'nw')"></div>
              <div class="resize-handle resize-se" (mousedown)="onResizeHandleMouseDown($event, item.key, 'se')"></div>
              <div class="resize-handle resize-sw" (mousedown)="onResizeHandleMouseDown($event, item.key, 'sw')"></div>
            }
          </div>
        }
      }
    </div>

    <!-- Pulsanti azioni mobile (fissi, non movibili) -->
    @if (canEdit()) {
      <div class="project-detail-modal__actions project-detail-modal__actions--mobile">
        <button 
          type="button"
          class="project-detail-modal__btn project-detail-modal__btn--preview project-detail-modal__btn--preview-mobile"
          (click)="togglePreviewMode()"
          title="Anteprima senza modalit√† edit">
          @if (isPreviewMode()) {
            <span>üîô Edit</span>
          } @else {
            <span>üëÅÔ∏è</span>
          }
        </button>
        <button 
          type="button"
          class="project-detail-modal__btn project-detail-modal__btn--cancel"
          (click)="onCancel()"
          [disabled]="saving()">
          Annulla
        </button>
        <button 
          type="button"
          class="project-detail-modal__btn project-detail-modal__btn--save"
          (click)="onSave()"
          [disabled]="saving() || editForm.invalid">
          @if (saving()) {
            <span>Salvataggio...</span>
          } @else {
            <span>Salva</span>
          }
        </button>
      </div>
    }
  </div>

  <!-- Selettore dispositivi desktop (fuori dal dialog, in alto) -->
  @if (canEdit() && !isPreviewMode()) {
    <div class="project-detail-modal__devices-bar">
      <!-- Selettore dispositivi -->
      <div class="device-selector">
        <button 
          type="button"
          class="device-btn device-btn--custom"
          (click)="openCustomSizeDialog()"
          title="Dimensione personalizzata">
          ‚öôÔ∏è
        </button>
        
        @for (device of devicePresets; track device.id) {
          <button 
            type="button"
            class="device-btn"
            [class.active]="selectedDevice().id === device.id"
            (click)="selectDevice(device)"
            [title]="device.name + ' (' + device.width + '√ó' + device.height + ')'">
            <span class="device-icon">{{ device.icon }}</span>
            <span class="device-label">{{ device.name }}</span>
          </button>
        }
      </div>

      <!-- Indicatore layout adattato -->
      @if (isLayoutAdapted()) {
        <div class="layout-adapted-notice">
          <span class="layout-adapted-notice__icon">‚ÑπÔ∏è</span>
          <span class="layout-adapted-notice__text">Layout adattato</span>
          <button 
            type="button"
            class="layout-adapted-notice__btn"
            (click)="saveAdaptedLayoutForCurrentDevice()"
            title="Salva questo layout come configurazione per {{ selectedDevice().name }}">
            üíæ Salva
          </button>
        </div>
      }

      <!-- Pulsanti per aggiungere elementi custom -->
      <div class="add-elements-toolbar">
        <button 
          type="button"
          class="add-element-btn"
          (click)="addCustomText()"
          title="Aggiungi testo">
          üìù
        </button>
        <button 
          type="button"
          class="add-element-btn"
          (click)="addCustomImage()"
          title="Aggiungi immagine">
          üñºÔ∏è
        </button>
      </div>
    </div>
  }

  <!-- Pulsanti azioni desktop (fuori dal dialog, a destra) -->
  @if (canEdit()) {
    <div class="project-detail-modal__actions project-detail-modal__actions--desktop">
      <!-- Riga: Preview, Annulla e Salva affiancati -->
      <div class="project-detail-modal__actions-row">
        <button 
          type="button"
          class="project-detail-modal__btn project-detail-modal__btn--preview"
          (click)="togglePreviewMode()"
          title="Anteprima senza modalit√† edit">
          @if (isPreviewMode()) {
            <span>üîô</span>
          } @else {
            <span>üëÅÔ∏è</span>
          }
        </button>
        <button 
          type="button"
          class="project-detail-modal__btn project-detail-modal__btn--cancel"
          (click)="onCancel()"
          [disabled]="saving()">
          Annulla
        </button>
        <button 
          type="button"
          class="project-detail-modal__btn project-detail-modal__btn--save"
          (click)="onSave()"
          [disabled]="saving() || editForm.invalid">
          @if (saving()) {
            <span>Salvataggio...</span>
          } @else {
            <span>Salva</span>
          }
        </button>
      </div>
    </div>
  }

  <!-- Dialog per dimensioni custom -->
  @if (showCustomSizeDialog()) {
    <div class="custom-size-overlay" (click)="showCustomSizeDialog.set(false)">
      <div class="custom-size-dialog" (click)="$event.stopPropagation()">
        <h3>Dimensioni Personalizzate</h3>
        <div class="custom-size-inputs">
          <label>
            <span>Larghezza (px)</span>
            <input 
              type="number" 
              [value]="customWidth()"
              (input)="customWidth.set(+$any($event.target).value)"
              min="320"
              max="3840">
          </label>
          <label>
            <span>Altezza (px)</span>
            <input 
              type="number"
              [value]="customHeight()"
              (input)="customHeight.set(+$any($event.target).value)"
              min="480"
              max="2160">
          </label>
        </div>
        <div class="custom-size-actions">
          <button 
            type="button"
            class="btn-secondary"
            (click)="showCustomSizeDialog.set(false)">
            Annulla
          </button>
          <button 
            type="button"
            class="btn-primary"
            (click)="applyCustomSize()">
            Applica
          </button>
        </div>
      </div>
    </div>
  }
</div>
