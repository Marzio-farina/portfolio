<app-notification 
  [notifications]="notificationService.notifications()"
  [showMultiple]="notificationService.showMultiple()"
  [mostSevereNotification]="getMostSevereNotification()">
</app-notification>

@if (mode() !== 'recover' && mode() !== 'reset-password') {
  <div class="tabs" role="tablist" aria-label="Seleziona modalit√†">
    <button
      class="tab"
      [class.active]="mode() === 'login'"
      role="tab"
      [attr.aria-selected]="mode() === 'login'"
      (click)="mode.set('login')">
      Accedi
    </button>
    <button
      class="tab"
      [class.active]="mode() === 'register'"
      role="tab"
      [attr.aria-selected]="mode() === 'register'"
      (click)="mode.set('register')">
      Registrati
    </button>
  </div>
} @else if (mode() === 'recover') {
  <h2 class="recover-title">Recupera</h2>
} @else if (mode() === 'reset-password') {
  <h2 class="recover-title">Reimposta Password</h2>
}

@if (mode() === 'login') {
  <form [formGroup]="loginForm" (ngSubmit)="submitLogin()" novalidate>

    <div class="field">
      <label for="login-email">Email</label>
      <input id="login-email" type="email" formControlName="email" autocomplete="email" required (blur)="onFieldBlur('login.email')" />
      <svg class="field-icon" viewBox="0 0 24 24" aria-hidden="true" (mouseenter)="showTooltip('login.email')" (mouseleave)="hideTooltip('login.email')">
        <path d="M11,18H13V16H11V18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6Z"/>
      </svg>
      <div class="field-tooltip" [class.show]="tooltipVisible() === 'login.email'">
        Inserisci un indirizzo email valido
      </div>
    </div>

    <div class="field password">
      <label for="login-password">Password</label>
      <input
        [type]="showLoginPass() ? 'text':'password'"
        id="login-password"
        formControlName="password"
        autocomplete="current-password"
        required (blur)="onFieldBlur('login.password')" />
      <button
        type="button"
        class="eye"
        (click)="showLoginPass.set(!showLoginPass())"
        [attr.aria-pressed]="showLoginPass()">üëÅÔ∏è</button>
      <svg class="field-icon" viewBox="0 0 24 24" aria-hidden="true" (mouseenter)="showTooltip('login.password')" (mouseleave)="hideTooltip('login.password')">
        <path d="M11,18H13V16H11V18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6Z"/>
      </svg>
      <div class="field-tooltip" [class.show]="tooltipVisible() === 'login.password'">
        Min 8 caratteri, usa maiuscole, minuscole e numeri
      </div>
    </div>

    <button class="primary" type="submit" [disabled]="loginForm.invalid || loading()">
      {{ loading() ? 'Accesso in corso‚Ä¶' : 'Accedi' }}
    </button>

    <div class="oauth-divider">
      <span>O continua con</span>
    </div>

    <div class="oauth-buttons">
      @for (provider of oauth.providers; track provider.provider) {
        <button 
          type="button"
          class="oauth-btn"
          [style.--oauth-color]="provider.color"
          (click)="oauth.loginWithProvider(provider.provider)"
          [disabled]="loading()">
          <svg [attr.viewBox]="provider.provider === 'google' ? '0 0 24 24' : '0 0 24 24'" class="oauth-icon">
            <path [attr.d]="provider.icon" [attr.fill]="provider.color"/>
          </svg>
          <span>{{ provider.name }}</span>
        </button>
      }
    </div>

    <p class="hint">
      Hai dimenticato la password?
      <a href="#" (click)="$event.preventDefault(); onForgotPassword()">Recupera</a>
    </p>
  </form>
} @else if (mode() === 'recover') {
  <form [formGroup]="recoverForm" (ngSubmit)="submitRecover()" novalidate>

    <div class="field">
      <label for="recover-email">Email</label>
      <input id="recover-email" type="email" formControlName="email" autocomplete="email" required (blur)="onFieldBlur('recover.email')" />
      <svg class="field-icon" viewBox="0 0 24 24" aria-hidden="true" (mouseenter)="showTooltip('recover.email')" (mouseleave)="hideTooltip('recover.email')">
        <path d="M11,18H13V16H11V18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6Z"/>
      </svg>
      <div class="field-tooltip" [class.show]="tooltipVisible() === 'recover.email'">
        Inserisci un indirizzo email valido
      </div>
    </div>

    <button class="primary" type="submit" [disabled]="recoverForm.invalid || loading()">
      {{ loading() ? 'Invio in corso‚Ä¶' : 'Recupera' }}
    </button>

    <p class="hint">
      <a href="#" (click)="$event.preventDefault(); mode.set('login')">Torna al login</a>
    </p>
  </form>
} @else if (mode() === 'reset-password') {
  <form [formGroup]="resetPasswordForm" (ngSubmit)="submitResetPassword()" novalidate>

    <div class="field">
      <label for="reset-email">Email</label>
      <input id="reset-email" type="email" formControlName="email" autocomplete="email" required readonly (blur)="onFieldBlur('reset-password.email')" />
      <svg class="field-icon" viewBox="0 0 24 24" aria-hidden="true" (mouseenter)="showTooltip('reset-password.email')" (mouseleave)="hideTooltip('reset-password.email')">
        <path d="M11,18H13V16H11V18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6Z"/>
      </svg>
      <div class="field-tooltip" [class.show]="tooltipVisible() === 'reset-password.email'">
        Email associata all'account
      </div>
    </div>

    <div class="field password">
      <label for="reset-password">Nuova Password</label>
      <input
        [type]="showResetPass() ? 'text':'password'"
        id="reset-password"
        formControlName="password"
        autocomplete="new-password"
        required (blur)="onFieldBlur('reset-password.password')" />
      <button
        type="button"
        class="eye"
        (click)="toggleResetPass()"
        [attr.aria-pressed]="showResetPass()">üëÅÔ∏è</button>
      <svg class="field-icon" viewBox="0 0 24 24" aria-hidden="true" (mouseenter)="showTooltip('reset-password.password')" (mouseleave)="hideTooltip('reset-password.password')">
        <path d="M11,18H13V16H11V18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6Z"/>
      </svg>
      <div class="field-tooltip" [class.show]="tooltipVisible() === 'reset-password.password'">
        Almeno 8 caratteri con maiuscole, minuscole e numeri
      </div>
    </div>

    <div class="field password">
      <label for="reset-confirm">Conferma Password</label>
      <input
        [type]="showResetPass() ? 'text':'password'"
        id="reset-confirm"
        formControlName="confirm"
        autocomplete="new-password"
        required (blur)="onFieldBlur('reset-password.confirm')" />
      <svg class="field-icon" viewBox="0 0 24 24" aria-hidden="true" (mouseenter)="showTooltip('reset-password.confirm')" (mouseleave)="hideTooltip('reset-password.confirm')">
        <path d="M11,18H13V16H11V18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6Z"/>
      </svg>
      <div class="field-tooltip" [class.show]="tooltipVisible() === 'reset-password.confirm'">
        Ripeti la stessa password
      </div>
    </div>

    <button class="primary" type="submit" [disabled]="resetPasswordForm.invalid || loading()">
      {{ loading() ? 'Reimpostazione in corso‚Ä¶' : 'Reimposta Password' }}
    </button>

    <p class="hint">
      <a href="#" (click)="$event.preventDefault(); mode.set('login')">Torna al login</a>
    </p>
  </form>
} @else {
  <form [formGroup]="registerForm" (ngSubmit)="submitRegister()" novalidate>

    <div class="field">
      <label for="reg-name">Nome</label>
      <input id="reg-name" type="text" formControlName="name" autocomplete="name" required (blur)="onFieldBlur('register.name')" />
      <svg class="field-icon" viewBox="0 0 24 24" aria-hidden="true" (mouseenter)="showTooltip('register.name')" (mouseleave)="hideTooltip('register.name')">
        <path d="M11,18H13V16H11V18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6Z"/>
      </svg>
      <div class="field-tooltip" [class.show]="tooltipVisible() === 'register.name'">
        Minimo 2 caratteri
      </div>
    </div>

    <div class="field">
      <label for="reg-email">Email</label>
      <input id="reg-email" type="email" formControlName="email" autocomplete="email" required (blur)="onFieldBlur('register.email')" />
      <svg class="field-icon" viewBox="0 0 24 24" aria-hidden="true" (mouseenter)="showTooltip('register.email')" (mouseleave)="hideTooltip('register.email')">
        <path d="M11,18H13V16H11V18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6Z"/>
      </svg>
      <div class="field-tooltip" [class.show]="tooltipVisible() === 'register.email'">
        Inserisci un indirizzo email valido
      </div>
    </div>

    <div class="field password">
      <label for="reg-password">Password</label>
      <input
        [type]="showRegPass() ? 'text':'password'"
        id="reg-password"
        formControlName="password"
        autocomplete="new-password"
        required (blur)="onFieldBlur('register.password')" />
      <button
        type="button"
        class="eye"
        (click)="showRegPass.set(!showRegPass())"
        [attr.aria-pressed]="showRegPass()">üëÅÔ∏è</button>
      <svg class="field-icon" viewBox="0 0 24 24" aria-hidden="true" (mouseenter)="showTooltip('register.password')" (mouseleave)="hideTooltip('register.password')">
        <path d="M11,18H13V16H11V18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6Z"/>
      </svg>
      <div class="field-tooltip" [class.show]="tooltipVisible() === 'register.password'">
        Almeno 8 caratteri con maiuscole, minuscole e numeri
      </div>
    </div>

    <div class="field">
      <label for="reg-confirm">Conferma password</label>
      <input
        [type]="showRegPass() ? 'text':'password'"
        id="reg-confirm"
        formControlName="confirm"
        required (blur)="onFieldBlur('register.confirm')" />
      <svg class="field-icon" viewBox="0 0 24 24" aria-hidden="true" (mouseenter)="showTooltip('register.confirm')" (mouseleave)="hideTooltip('register.confirm')">
        <path d="M11,18H13V16H11V18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6Z"/>
      </svg>
      <div class="field-tooltip" [class.show]="tooltipVisible() === 'register.confirm'">
        Ripeti la stessa password
      </div>
    </div>

    <div class="consent">
      <label class="consent__row">
        <input type="checkbox" formControlName="terms" (blur)="onFieldBlur('register.terms')" />
        <span class="consent__text">
          Acconsento al trattamento dei dati. 
          <a href="#" (click)="$event.preventDefault()">Informativa Privacy</a>
        </span>
      </label>
    </div>

    <button class="primary" type="submit" [disabled]="registerForm.invalid || loading()">
      {{ loading() ? 'Registrazione‚Ä¶' : 'Crea account' }}
    </button>

    <div class="oauth-divider">
      <span>O registrati con</span>
    </div>

    <div class="oauth-buttons">
      @for (provider of oauth.providers; track provider.provider) {
        <button 
          type="button"
          class="oauth-btn"
          [style.--oauth-color]="provider.color"
          (click)="oauth.loginWithProvider(provider.provider)"
          [disabled]="loading()">
          <svg [attr.viewBox]="provider.provider === 'google' ? '0 0 24 24' : '0 0 24 24'" class="oauth-icon">
            <path [attr.d]="provider.icon" [attr.fill]="provider.color"/>
          </svg>
          <span>{{ provider.name }}</span>
        </button>
      }
    </div>
  </form>
}