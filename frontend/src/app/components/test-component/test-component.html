<div class="test-component w-full">
  <h2 class="text-lg sm:text-3xl font-bold text-center mb-2 sm:mb-8 px-2 sm:px-0">Carosello Testimonial</h2>
  
  @if (testimonialsLoading()) {
    <div class="text-center py-8">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
  }
  
  @else if (testimonialsError()) {
    <div class="text-center py-8 text-red-500">
      <p>{{ testimonialsError() }}</p>
    </div>
  }
  
  @else if (testimonials().length > 0) {
    <div class="relative w-full">
      <div class="w-full h-auto overflow-visible relative" id="carousel-container">
        <div 
          class="flex transition-transform duration-500 ease-in-out"
          [style.transform]="getTransform()"
          style="width: 100%; max-width: 100%; overflow: visible;"
          (wheel)="onWheelToHorizontal($event)"
        >
          @for (testimonial of testimonials(); track testimonial.id; let i = $index) {
            <div 
              class="carousel-slide px-0.5 sm:px-2"
              [style.min-width.%]="(100 / cardsPerView())"
            >
              <div class="testimonial-card-wrap">
                <app-avatar class="testimonial-avatar" [width]="72" [avatarData]="getAvatarData(testimonial)"></app-avatar>
                <div class="card" (mouseenter)="onMouseEnter()" (mouseleave)="onMouseLeave()">
                  <div class="description_card" (click)="openDialog(testimonial)">
                    <h4>{{ testimonial.author }}</h4>
                    @if (testimonial.rating) {
                      <div class="rating-container">
                        <div class="stars-rating">
                          <!-- @for (star of [1, 2, 3, 4, 5]; track star) {
                            <span class="star" [class.active]="star <= testimonial.rating">★</span>
                          } -->
                        </div>
                      </div>
                    }
                    <p>{{ testimonial.text }}</p>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      </div>

      <div class="absolute flex justify-between w-full px-2 transform -translate-y-1/2 left-0 right-0 top-1/2 z-20 pointer-events-none">
        <button 
          class="btn btn-sm sm:btn-md btn-circle glass text-xs sm:text-base pointer-events-auto shadow-lg"
          (click)="prevSlide()"
        >
          ❮
        </button>
        <button 
          class="btn btn-sm sm:btn-md btn-circle glass text-xs sm:text-base pointer-events-auto shadow-lg"
          (click)="nextSlide()"
        >
          ❯
        </button>
      </div>

      <div class="w-full px-2 sm:px-4 mt-2">
        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
          <div 
            class="h-full bg-amber-500 transition-all duration-300"
            [style.width.%]="((currentSlide() + 1) / maxSlides()) * 100"
          ></div>
        </div>
      </div>
    </div>
  } @else {
    <div class="text-center py-8 text-gray-500">
      <p>Nessuna testimonianza disponibile.</p>
    </div>
  }
  
  @if (dialogOpen()) {
    <div class="testimonial-dialog-overlay" (click)="closeDialog()">
      <div class="testimonial-dialog" (click)="$event.stopPropagation()">
        <button class="testimonial-dialog-close" (click)="closeDialog()" type="button">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>

        @if (selectedTestimonial()) {
          <div class="testimonial-dialog-header">
            <div class="testimonial-avatar">
              <app-avatar [width]="64" [avatarData]="getAvatarData(selectedTestimonial()!)"></app-avatar>
            </div>
            <div class="testimonial-info">
              <h3 class="testimonial-dialog-author">{{ selectedTestimonial()!.author }}</h3>
              @if (selectedTestimonial()!.role || selectedTestimonial()!.company) {
                <div class="testimonial-dialog-meta">
                  @if (selectedTestimonial()!.role) { <span>{{ selectedTestimonial()!.role }}</span> }
                  @if (selectedTestimonial()!.role && selectedTestimonial()!.company) { <span> • </span> }
                  @if (selectedTestimonial()!.company) { <span>{{ selectedTestimonial()!.company }}</span> }
                </div>
              }
            </div>
          </div>
        }

        <div class="testimonial-dialog-content-wrapper">
          <span class="testimonial-quote-mark">"</span>
          <div class="testimonial-dialog-content" [class.typing]="isTyping()">
            {{ displayedText() }}
          </div>
        </div>

        @if (selectedTestimonial() && selectedTestimonial()!.rating) {
          <div class="testimonial-dialog-rating">
            <div class="stars-rating">
              @for (star of [1, 2, 3, 4, 5]; track star) {
                <span class="star" [class.active]="star <= selectedTestimonial()!.rating">★</span>
              }
            </div>
          </div>
        }
      </div>
    </div>
  }
</div>