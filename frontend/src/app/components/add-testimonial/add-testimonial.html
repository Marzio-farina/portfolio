<!-- Sistema di notifiche multiple -->
<app-notification 
  [notifications]="notifications()"
  [showMultiple]="showMultipleNotifications"
  [mostSevereNotification]="getMostSevereNotification()">
</app-notification>

<section class="add-testimonial">
  <div class="header">
    <button class="back-btn" (click)="goBack()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
    </button>
    <h2 class="title">Lascia una Recensione</h2>
  </div>

  @if (sent()) {
    <div class="success-message">
      <p>Grazie per la tua recensione!</p>
      <p class="subtitle">Ti stiamo riportando alla pagina principale...</p>
    </div>
  } @else {
    <form class="form" (ngSubmit)="submit()" [formGroup]="form" novalidate>
      <div class="row">
        <label class="field field--name">
          <input type="text" formControlName="author_name" placeholder=" " required (blur)="onFieldBlur('author_name')"/>
          <span class="field-label">Nome</span>
          <svg class="field-icon" viewBox="0 0 24 24" aria-hidden="true" (mouseenter)="showTooltip('name')" (mouseleave)="hideTooltip('name')">
            <path d="M11,18H13V16H11V18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6Z"/>
          </svg>
          <div class="field-tooltip" [class.show]="tooltipVisible === 'name'">
            Inserisci il tuo nome
          </div>
        </label>
        <label class="field field--surname hidden-mobile">
          <input type="text" formControlName="author_surname" placeholder=" " (blur)="onFieldBlur('author_surname')"/>
          <span class="field-label">Cognome (opzionale)</span>
          <svg class="field-icon" viewBox="0 0 24 24" aria-hidden="true" (mouseenter)="showTooltip('surname')" (mouseleave)="hideTooltip('surname')">
            <path d="M11,18H13V16H11V18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6Z"/>
          </svg>
          <div class="field-tooltip" [class.show]="tooltipVisible === 'surname'">
            Inserisci il tuo cognome
          </div>
        </label>
        <label class="field field--avatar hidden-mobile">
          <div class="avatar-container">
            <!-- Freccia sinistra -->
            <button type="button" class="avatar-nav-btn avatar-nav-prev" (click)="previousDefaultAvatar()" [disabled]="!canGoToPreviousAvatar()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M15 18l-6-6 6-6"/>
              </svg>
            </button>
            
            <!-- Avatar preview -->
            <div class="avatar-preview" (click)="avatarFileInput.click()">
              <img [src]="getAvatarUrl()" [alt]="'Avatar di ' + form.get('author_name')?.value" class="avatar-image"/>
              <div class="avatar-overlay">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/>
                  <circle cx="12" cy="13" r="3"/>
                </svg>
              </div>
            </div>
            
            <!-- Freccia destra -->
            <button type="button" class="avatar-nav-btn avatar-nav-next" (click)="nextDefaultAvatar()" [disabled]="!canGoToNextAvatar()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 18l6-6-6-6"/>
              </svg>
            </button>
          </div>
          
          <input type="file" accept=".jpg,.jpeg,.png,.gif,.webp" capture="user" (change)="onAvatarFileSelected($event)" class="avatar-file-input" #avatarFileInput/>
          <input type="url" formControlName="avatar_url" (blur)="onFieldBlur('avatar_url')" class="avatar-url-input"/>
        </label>
      </div>

      <div class="row hidden-mobile">
        <label class="field">
          <input type="text" formControlName="company" placeholder=" " (blur)="onFieldBlur('company')"/>
          <span class="field-label">Azienda (opzionale)</span>
          <svg class="field-icon" viewBox="0 0 24 24" aria-hidden="true" (mouseenter)="showTooltip('company')" (mouseleave)="hideTooltip('company')">
            <path d="M11,18H13V16H11V18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6Z"/>
          </svg>
          <div class="field-tooltip" [class.show]="tooltipVisible === 'company'">
            Inserisci la tua azienda
          </div>
        </label>
        <label class="field">
          <input type="text" formControlName="role_company" placeholder=" " (blur)="onFieldBlur('role_company')"/>
          <span class="field-label">Ruolo (opzionale)</span>
          <svg class="field-icon" viewBox="0 0 24 24" aria-hidden="true" (mouseenter)="showTooltip('role')" (mouseleave)="hideTooltip('role')">
            <path d="M11,18H13V16H11V18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6Z"/>
          </svg>
          <div class="field-tooltip" [class.show]="tooltipVisible === 'role'">
            Inserisci il tuo ruolo
          </div>
        </label>
      </div>

      <label class="field field--textarea">
        <textarea rows="6" formControlName="text" placeholder=" " required (blur)="onFieldBlur('text')"></textarea>
        <span class="field-label">La tua recensione...</span>
        <svg class="field-icon" viewBox="0 0 24 24" aria-hidden="true" (mouseenter)="showTooltip('text')" (mouseleave)="hideTooltip('text')">
          <path d="M11,18H13V16H11V18M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A4,4 0 0,0 8,10H10A2,2 0 0,1 12,8A2,2 0 0,1 14,10C14,12 11,11.75 11,15H13C13,12.75 16,12.5 16,10A4,4 0 0,0 12,6Z"/>
        </svg>
        <div class="field-tooltip" [class.show]="tooltipVisible === 'text'">
          Scrivi minimo 10 caratteri
        </div>
      </label>

      <div class="rating-container">
        <span class="rating-label">Valutazione</span>
        <div class="rating-input">
          <input type="radio" name="rating" [value]="1" formControlName="rating" id="rating-1"/>
          <label for="rating-1" (mouseenter)="hoverRating.set(1)" (mouseleave)="hoverRating.set(0)" [ngClass]="{'star-filled': (hoverRating() > 0 ? hoverRating() >= 1 : (form.get('rating')?.value ?? 0) >= 1), 'star-hover': hoverRating() > 0 && hoverRating() >= 1, 'star-dimmed': hoverRating() > 0 && (form.get('rating')?.value ?? 0) > hoverRating() && 1 > hoverRating() && (form.get('rating')?.value ?? 0) >= 1}">
            <svg class="star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <polygon points="12 2 15.09 10.26 24 10.35 17.82 16.54 20.91 24 12 18.81 3.09 24 6.18 16.54 0 10.35 8.91 10.26 12 2"></polygon>
            </svg>
          </label>
          <input type="radio" name="rating" [value]="2" formControlName="rating" id="rating-2"/>
          <label for="rating-2" (mouseenter)="hoverRating.set(2)" (mouseleave)="hoverRating.set(0)" [ngClass]="{'star-filled': (hoverRating() > 0 ? hoverRating() >= 2 : (form.get('rating')?.value ?? 0) >= 2), 'star-hover': hoverRating() > 0 && hoverRating() >= 2, 'star-dimmed': hoverRating() > 0 && (form.get('rating')?.value ?? 0) > hoverRating() && 2 > hoverRating() && (form.get('rating')?.value ?? 0) >= 2}">
            <svg class="star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <polygon points="12 2 15.09 10.26 24 10.35 17.82 16.54 20.91 24 12 18.81 3.09 24 6.18 16.54 0 10.35 8.91 10.26 12 2"></polygon>
            </svg>
          </label>
          <input type="radio" name="rating" [value]="3" formControlName="rating" id="rating-3"/>
          <label for="rating-3" (mouseenter)="hoverRating.set(3)" (mouseleave)="hoverRating.set(0)" [ngClass]="{'star-filled': (hoverRating() > 0 ? hoverRating() >= 3 : (form.get('rating')?.value ?? 0) >= 3), 'star-hover': hoverRating() > 0 && hoverRating() >= 3, 'star-dimmed': hoverRating() > 0 && (form.get('rating')?.value ?? 0) > hoverRating() && 3 > hoverRating() && (form.get('rating')?.value ?? 0) >= 3}">
            <svg class="star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <polygon points="12 2 15.09 10.26 24 10.35 17.82 16.54 20.91 24 12 18.81 3.09 24 6.18 16.54 0 10.35 8.91 10.26 12 2"></polygon>
            </svg>
          </label>
          <input type="radio" name="rating" [value]="4" formControlName="rating" id="rating-4"/>
          <label for="rating-4" (mouseenter)="hoverRating.set(4)" (mouseleave)="hoverRating.set(0)" [ngClass]="{'star-filled': (hoverRating() > 0 ? hoverRating() >= 4 : (form.get('rating')?.value ?? 0) >= 4), 'star-hover': hoverRating() > 0 && hoverRating() >= 4, 'star-dimmed': hoverRating() > 0 && (form.get('rating')?.value ?? 0) > hoverRating() && 4 > hoverRating() && (form.get('rating')?.value ?? 0) >= 4}">
            <svg class="star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <polygon points="12 2 15.09 10.26 24 10.35 17.82 16.54 20.91 24 12 18.81 3.09 24 6.18 16.54 0 10.35 8.91 10.26 12 2"></polygon>
            </svg>
          </label>
          <input type="radio" name="rating" [value]="5" formControlName="rating" id="rating-5"/>
          <label for="rating-5" (mouseenter)="hoverRating.set(5)" (mouseleave)="hoverRating.set(0)" [ngClass]="{'star-filled': (hoverRating() > 0 ? hoverRating() >= 5 : (form.get('rating')?.value ?? 0) >= 5), 'star-hover': hoverRating() > 0 && hoverRating() >= 5, 'star-dimmed': hoverRating() > 0 && (form.get('rating')?.value ?? 0) > hoverRating() && 5 > hoverRating() && (form.get('rating')?.value ?? 0) >= 5}">
            <svg class="star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <polygon points="12 2 15.09 10.26 24 10.35 17.82 16.54 20.91 24 12 18.81 3.09 24 6.18 16.54 0 10.35 8.91 10.26 12 2"></polygon>
            </svg>
          </label>
        </div>
      </div>

      <div class="actions">
        <button type="button" class="btn btn-secondary" (click)="goBack()">
          Annulla
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="sending()">
          @if (!sending()) {
            <span>Invia Recensione</span>
          } @else if (sending()) {
            <span>Invio...</span>
          }
        </button>
      </div>
    </form>
  }
</section>
