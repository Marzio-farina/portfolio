<!-- Header con pulsante aggiungi testimonial -->
<div class="testimonials-header">
    <h3 class="sub_article-title">Testimonianze</h3>
    <button class="add-testimonial-btn" (click)="openAddTestimonial()" aria-label="Aggiungi testimonianza" title="Aggiungi testimonianza">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>
</div>

<!-- Stati di caricamento -->
@if (testimonialsLoading()) {
  <div class="testimonial-carousel-card w-full">
    <div class="relative w-full">
      <div class="w-full h-auto overflow-visible relative" id="carousel-container">
        <div class="flex" style="width: 100%; max-width: 100%; overflow: visible;">
          @for (i of [0,1,2]; track i) {
            <div class="carousel-slide px-0.5 sm:px-2" [style.min-width.%]="(100 / cardsPerView())">
              <div class="testimonial-card-wrap">
                <div class="skel-avatar skeleton"></div>
                <div class="card skel-card">
                  <div class="description_card">
                    <div class="skeleton skel-title"></div>
                    <div class="skeleton skel-line"></div>
                    <div class="skeleton skel-line short"></div>
                    <div class="skel-dots">
                      @for (d of [0,1,2,3,4]; track d) { <div class="skeleton dot"></div> }
                    </div>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
}
@if (!testimonialsLoading() && testimonialsError()) {
  <div class="state error">{{ testimonialsError() }}</div>
}
@if (!testimonialsLoading() && !testimonialsError() && testimonials().length === 0) {
  <div class="state empty">Nessuna testimonianza disponibile.</div>
}

<div class="testimonial-carousel-card w-full">
  @if (!testimonialsLoading() && !testimonialsError() && testimonials().length > 0) {
    <div class="relative w-full">
      <div class="w-full h-auto overflow-visible relative" id="carousel-container">
        <div 
          class="flex transition-transform duration-500 ease-in-out"
          [style.transform]="getTransform()"
          style="width: 100%; max-width: 100%; overflow: visible;"
          (wheel)="onWheelToHorizontal($event)"
        >
          @for (testimonial of testimonials(); track testimonial.id; let i = $index) {
            <div 
              class="carousel-slide px-0.5 sm:px-2"
              [style.min-width.%]="(100 / cardsPerView())"
            >
              <div class="testimonial-card-wrap">
                <app-avatar class="testimonial-avatar" [width]="72" [avatarData]="getAvatarData(testimonial)"></app-avatar>
                <div class="card" (mouseenter)="onMouseEnter()" (mouseleave)="onMouseLeave()">
                  <div class="description_card" (click)="openDialog(testimonial)">
                    <h4>{{ truncateAuthor(testimonial.author) }}</h4>
                    @if (testimonial.rating) {
                      <div class="rating-container">
                        <div class="rating rating-sm" role="img" [attr.aria-label]="'Valutazione ' + testimonial.rating + ' su 5 stelle'">
                          <input type="radio" class="mask mask-star-2 bg-amber-400" [name]="'rating-' + testimonial.id" [checked]="testimonial.rating === 1" disabled aria-label="1 stella" />
                          <input type="radio" class="mask mask-star-2 bg-amber-400" [name]="'rating-' + testimonial.id" [checked]="testimonial.rating === 2" disabled aria-label="2 stelle" />
                          <input type="radio" class="mask mask-star-2 bg-amber-400" [name]="'rating-' + testimonial.id" [checked]="testimonial.rating === 3" disabled aria-label="3 stelle" />
                          <input type="radio" class="mask mask-star-2 bg-amber-400" [name]="'rating-' + testimonial.id" [checked]="testimonial.rating === 4" disabled aria-label="4 stelle" />
                          <input type="radio" class="mask mask-star-2 bg-amber-400" [name]="'rating-' + testimonial.id" [checked]="testimonial.rating === 5" disabled aria-label="5 stelle" />
                        </div>
                      </div>
                    }
                    <p>{{ testimonial.text }}</p>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      </div>

      <div class="absolute flex justify-between w-full px-2 transform -translate-y-1/2 left-0 right-0 top-1/2 z-20 pointer-events-none">
        <button 
          class="btn btn-sm sm:btn-md btn-circle glass text-xs sm:text-base pointer-events-auto shadow-lg"
          (click)="prevSlide()"
        >
          ❮
        </button>
        <button 
          class="btn btn-sm sm:btn-md btn-circle glass text-xs sm:text-base pointer-events-auto shadow-lg"
          (click)="nextSlide()"
        >
          ❯
        </button>
      </div>

      <div class="w-full px-2 sm:px-4 mt-2">
        <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
          <div 
            class="h-full bg-amber-500 transition-all duration-300"
            [style.width.%]="((currentSlide() + 1) / maxSlides()) * 100"
          ></div>
        </div>
      </div>
    </div>
  }
  
  @if (dialogOpen()) {
    <div class="testimonial-dialog-overlay" (click)="closeDialog()">
      <div class="testimonial-dialog" (click)="$event.stopPropagation()">
        <button class="testimonial-dialog-close" (click)="closeDialog()" type="button">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>

        @if (selectedTestimonial()) {
          <div class="testimonial-dialog-header">
            <div class="testimonial-avatar">
              <app-avatar [width]="64" [avatarData]="getAvatarData(selectedTestimonial()!)"></app-avatar>
            </div>
            <div class="testimonial-info">
              <h3 class="testimonial-dialog-author">{{ selectedTestimonial()!.author }}</h3>
              @if (selectedTestimonial()!.role || selectedTestimonial()!.company) {
                <div class="testimonial-dialog-meta">
                  @if (selectedTestimonial()!.role) { <span>{{ selectedTestimonial()!.role }}</span> }
                  @if (selectedTestimonial()!.role && selectedTestimonial()!.company) { <span> • </span> }
                  @if (selectedTestimonial()!.company) { <span>{{ selectedTestimonial()!.company }}</span> }
                </div>
              }
            </div>
          </div>
        }

        <div class="testimonial-dialog-content-wrapper">
          <span class="testimonial-quote-mark">"</span>
          <div class="testimonial-dialog-content" [class.typing]="isTyping()">
            {{ displayedText() }}
          </div>
        </div>

        @if (selectedTestimonial() && selectedTestimonial()!.rating) {
          <div class="testimonial-dialog-rating">
            <div class="rating rating-sm" role="img" [attr.aria-label]="'Valutazione ' + selectedTestimonial()!.rating + ' su 5 stelle'">
              <input type="radio" class="mask mask-star-2 bg-amber-400" [name]="'rating-dialog-' + selectedTestimonial()!.id" [checked]="selectedTestimonial()!.rating === 1" disabled aria-label="1 stella" />
              <input type="radio" class="mask mask-star-2 bg-amber-400" [name]="'rating-dialog-' + selectedTestimonial()!.id" [checked]="selectedTestimonial()!.rating === 2" disabled aria-label="2 stelle" />
              <input type="radio" class="mask mask-star-2 bg-amber-400" [name]="'rating-dialog-' + selectedTestimonial()!.id" [checked]="selectedTestimonial()!.rating === 3" disabled aria-label="3 stelle" />
              <input type="radio" class="mask mask-star-2 bg-amber-400" [name]="'rating-dialog-' + selectedTestimonial()!.id" [checked]="selectedTestimonial()!.rating === 4" disabled aria-label="4 stelle" />
              <input type="radio" class="mask mask-star-2 bg-amber-400" [name]="'rating-dialog-' + selectedTestimonial()!.id" [checked]="selectedTestimonial()!.rating === 5" disabled aria-label="5 stelle" />
            </div>
          </div>
        }
      </div>
    </div>
  }
</div>

