<!-- Sistema di notifiche multiple -->
<app-notification 
  [notifications]="notificationService.notifications()"
  [showMultiple]="notificationService.showMultiple()"
  [mostSevereNotification]="getMostSevereNotification()">
</app-notification>

<section class="job-offer-detail">
  <!-- Header con back button e titolo -->
  <div class="header">
    <button class="back-btn" type="button" (click)="goBack()" aria-label="Torna indietro">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
    </button>
    <h2 class="title">
      @if (isHistoryMode()) {
        Cronologia Ricerche
      } @else {
        Risultati Ricerca Offerte
      }
    </h2>
  </div>

  <!-- Pulsante Toggle Filtri -->
  <button 
    class="filter-toggle-btn" 
    (click)="toggleFilters()" 
    (mouseenter)="showFiltersOnHover()"
    type="button"
    [class.active]="filtersVisible()"
    [attr.aria-label]="filtersVisible() ? 'Nascondi filtri' : 'Mostra filtri'"
    title="Toggle Filtri">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
    </svg>
  </button>

  <!-- Pulsante Cronologia Scraping -->
  <button 
    class="history-toggle-btn" 
    (click)="toggleHistory()"
    type="button"
    [class.active]="historyVisible()"
    [attr.aria-label]="historyVisible() ? 'Nascondi cronologia' : 'Mostra cronologia'"
    title="Cronologia Scraping">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"/>
      <polyline points="12 6 12 12 16 14"/>
    </svg>
  </button>

  <!-- Search Form Component -->
  <app-search-form
    [filtersVisible]="filtersVisible()"
    [isHistoryMode]="isHistoryMode()"
    [searchQuery]="searchQuery()"
    [searchKeyword]="searchKeyword()"
    [loading]="loading()"
    [searchParamsChanged]="searchParamsChanged()"
    (performSearch)="performSearch()"
    (resetFilters)="resetFilters()"
    (searchQueryChange)="searchQuery.set($event)">
  </app-search-form>

  <!-- Layout principale: Filtri laterali + Tabella -->
  <div class="content-layout" [class.filters-hidden]="!filtersVisible()">
    <!-- Search Filters Component -->
    @if (filtersVisible()) {
      <app-search-filters
        [scrapedJobs]="scrapedJobs()"
        [salaryRange]="salaryRange()"
        [currencySymbol]="currencySymbol()"
        [searchKeyword]="searchKeyword()"
        [searchLocationInput]="searchLocationInput()"
        [resultsLimit]="resultsLimit()"
        [selectedCompany]="selectedCompany()"
        [selectedEmploymentType]="selectedEmploymentType()"
        [selectedRemote]="selectedRemote()"
        [minSalary]="minSalary()"
        [maxSalary]="maxSalary()"
        [selectedCurrency]="selectedCurrency()"
        [availableCurrencies]="availableCurrencies"
        [availableCompanies]="availableCompanies()"
        [availableEmploymentTypes]="availableEmploymentTypes()"
        [availableRemoteTypes]="availableRemoteTypes()"
        [filteredJobsCount]="filteredJobs().length"
        (searchKeywordChange)="searchKeyword.set($event)"
        (searchLocationInputChange)="searchLocationInput.set($event)"
        (resultsLimitChange)="resultsLimit.set($event)"
        (selectedCompanyChange)="selectedCompany.set($event)"
        (selectedEmploymentTypeChange)="selectedEmploymentType.set($event)"
        (selectedRemoteChange)="selectedRemote.set($event)"
        (minSalaryChange)="onMinSalaryChange($event)"
        (maxSalaryChange)="onMaxSalaryChange($event)"
        (selectedCurrencyChange)="onCurrencyChange($event)"
        (checkParamsChanged)="checkAndShowParamsChangedNotification()">
      </app-search-filters>
    }

    <!-- Job Results Table Component -->
    <app-job-results-table
      [filteredJobs]="filteredJobs()"
      [allColumns]="allColumns()"
      [mainColumns]="mainColumns()"
      [loading]="loading()"
      [editMode]="editMode()"
      [sortColumn]="sortColumn()"
      [sortDirection]="sortDirection()"
      [expandedRows]="expandedRows()"
      [draggedColumnId]="draggedColumnId()"
      [dragOverColumnId]="dragOverColumnId()"
      [tableOptionsOpen]="tableOptionsOpen()"
      (columnSort)="onColumnSort($event)"
      (rowExpansion)="toggleRowExpansion($event)"
      (openJobUrl)="openJobUrl($event)"
      (dragStart)="onDragStart($event.event, $event.columnId)"
      (dragOver)="onDragOver($event.event, $event.columnId)"
      (dragLeave)="onDragLeave($event)"
      (drop)="onDrop($event.event, $event.columnId)"
      (dragEnd)="onDragEnd()"
      (toggleTableOptions)="toggleTableOptions()"
      (closeTableOptions)="closeTableOptions()"
      (toggleColumnVisibility)="toggleColumnVisibility($event.columnId, $event.visible)">
    </app-job-results-table>
  </div>
</section>
