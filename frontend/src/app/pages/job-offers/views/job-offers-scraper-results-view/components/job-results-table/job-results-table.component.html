<div class="table-container">
  <!-- Pulsante opzioni tabella (visibile solo in Edit Mode) -->
  @if (editMode) {
    <button 
      class="table-options-btn"
      type="button"
      title="Opzioni tabella"
      (click)="onToggleTableOptions()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
        <circle cx="12" cy="12" r="3"/>
      </svg>
    </button>

    <!-- Popup opzioni tabella -->
    <app-table-options-popup
      [allColumns]="allColumns"
      [tableOptionsOpen]="tableOptionsOpen"
      (closePopup)="onCloseTableOptions()"
      (toggleVisibility)="onToggleColumnVisibility($event)">
    </app-table-options-popup>
  }

  <!-- Empty State -->
  @if (!loading && filteredJobs.length === 0) {
    <div class="empty-state">
      <svg class="empty-icon empty-icon--search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"/>
        <path d="m21 21-4.35-4.35"/>
      </svg>
      <h3>Inizia la Ricerca</h3>
      <p>Inserisci una Professione e una localit√†, poi clicca su "Cerca"</p>
    </div>
  } @else {
    <div class="overflow-x-auto">
      <table class="table table-zebra">
        <!-- Skeleton durante caricamento -->
        @if (loading && allColumns.length === 0) {
          <thead>
            <tr>
              @if (hasExtraColumns()) {
                <th class="expand-column"></th>
              }
              @for (i of [0, 1, 2]; track i) {
                <th><div class="skeleton skeleton-header"></div></th>
              }
              <th class="column-action"><div class="skeleton skeleton-header"></div></th>
            </tr>
          </thead>
          <tbody>
            @for (i of skeletonRows; track i) {
              <tr class="skeleton-row">
                @if (hasExtraColumns()) {
                  <td class="expand-cell">
                    <div class="skeleton skeleton-text" style="width: 20px; margin: auto;"></div>
                  </td>
                }
                @for (j of [0, 1, 2]; track j) {
                  <td><div class="skeleton skeleton-text"></div></td>
                }
                <td class="column-action"><div class="skeleton skeleton-text"></div></td>
              </tr>
            }
          </tbody>
        } @else {
          <!-- Headers reali -->
          <thead>
            <tr>
              @if (hasExtraColumns()) {
                <th class="expand-column"></th>
              }
              
              @for (column of mainColumns; track column.id) {
                <th 
                  [class.column-status]="column.field_name === 'status'"
                  [class.column-date]="column.field_name === 'application_date' || column.field_name === 'announcement_date'"
                  [draggable]="editMode"
                  [class.draggable]="editMode"
                  [class.dragging]="isColumnDragging(column.id)"
                  [class.drop-target]="isColumnDropTarget(column.id)"
                  (dragstart)="onDragStart($event, column.id)"
                  (dragover)="onDragOver($event, column.id)"
                  (dragleave)="onDragLeave($event)"
                  (drop)="onDrop($event, column.id)"
                  (dragend)="onDragEnd()">
                  <div class="th-content" (click)="onColumnSort(column.field_name)">
                    @if (editMode) {
                      <svg class="drag-handle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                      </svg>
                    }
                    <span class="th-text">{{ column.title }}</span>
                    @if (!editMode) {
                      <svg 
                        class="sort-icon"
                        [class.sort-icon--active]="sortColumn === column.field_name"
                        [class.sort-icon--asc]="sortColumn === column.field_name && sortDirection === 'asc'"
                        [class.sort-icon--desc]="sortColumn === column.field_name && sortDirection === 'desc'"
                        viewBox="0 0 24 24" 
                        fill="none" 
                        stroke="currentColor" 
                        stroke-width="2.5" 
                        stroke-linecap="round" 
                        stroke-linejoin="round">
                        <path d="M12 5v14M19 12l-7 7-7-7"/>
                      </svg>
                    }
                  </div>
                </th>
              }

              <th class="column-action">
                <div class="th-content">
                  <span class="th-text">Candidati</span>
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            <!-- Skeleton rows durante loading -->
            @if (loading) {
              @for (i of skeletonRows; track i) {
                <tr class="skeleton-row">
                  @if (hasExtraColumns()) {
                    <td class="expand-cell">
                      <div class="skeleton skeleton-text" style="width: 20px; margin: auto;"></div>
                    </td>
                  }
                  @for (column of mainColumns; track column.id) {
                    <td 
                      [class.column-status]="column.field_name === 'status'"
                      [class.column-date]="column.field_name === 'application_date' || column.field_name === 'announcement_date'">
                      <div class="skeleton skeleton-text"></div>
                    </td>
                  }
                  <td class="column-action">
                    <div class="skeleton skeleton-text"></div>
                  </td>
                </tr>
              }
            } @else {
              <!-- Righe reali -->
              @for (job of filteredJobs; track job.id) {
                <tr class="data-row" [class.row-expanded]="isRowExpanded(job.id)">
                  @if (hasExtraColumns()) {
                    <td class="expand-cell" (click)="toggleRowExpansion(job.id)">
                      <svg 
                        class="expand-icon"
                        [class.expand-icon--expanded]="isRowExpanded(job.id)"
                        viewBox="0 0 24 24" 
                        fill="none" 
                        stroke="currentColor" 
                        stroke-width="2" 
                        stroke-linecap="round" 
                        stroke-linejoin="round">
                        <path d="m9 18 6-6-6-6"/>
                      </svg>
                    </td>
                  }
                  
                  @for (column of mainColumns; track column.id) {
                    <td 
                      [class.column-status]="column.field_name === 'status'"
                      [class.column-date]="column.field_name === 'application_date' || column.field_name === 'announcement_date'"
                      (click)="hasExtraColumns() && toggleRowExpansion(job.id)">
                      {{ formatValue(getFieldValue(job, column.field_name), column.field_name) }}
                    </td>
                  }

                  <td class="column-action">
                    <button 
                      class="btn btn-sm btn-primary view-btn"
                      type="button"
                      (click)="onOpenJobUrl(job.url)"
                      title="Visualizza offerta">
                      Visualizza
                    </button>
                  </td>
                </tr>

                <!-- Riga espandibile con colonne extra -->
                @if (hasExtraColumns() && isRowExpanded(job.id)) {
                  <tr class="expanded-row">
                    <td [attr.colspan]="mainColumns.length + 2" class="expanded-cell">
                      <div class="expanded-content">
                        @for (column of getPopulatedExtraColumns(job); track column.id) {
                          <div 
                            class="extra-field"
                            [class.extra-field--notes]="column.field_name === 'notes'"
                            [draggable]="editMode"
                            [class.extra-field--draggable]="editMode"
                            [class.extra-field--dragging]="isColumnDragging(column.id)"
                            [class.extra-field--drop-target]="isColumnDropTarget(column.id)"
                            (dragstart)="onDragStart($event, column.id)"
                            (dragover)="onDragOver($event, column.id)"
                            (dragleave)="onDragLeave($event)"
                            (drop)="onDrop($event, column.id)"
                            (dragend)="onDragEnd()">
                            @if (editMode) {
                              <svg class="drag-handle drag-handle--extra" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="3" y1="12" x2="21" y2="12"/>
                                <line x1="3" y1="6" x2="21" y2="6"/>
                                <line x1="3" y1="18" x2="21" y2="18"/>
                              </svg>
                            }
                            <div class="extra-field__content">
                              <span class="extra-field__label">{{ column.title }}:</span>
                              <span class="extra-field__value">
                                {{ formatValue(getFieldValue(job, column.field_name), column.field_name) }}
                              </span>
                            </div>
                          </div>
                        }
                      </div>
                    </td>
                  </tr>
                }
              }
            }
          </tbody>
        }
      </table>
    </div>
  }
</div>

